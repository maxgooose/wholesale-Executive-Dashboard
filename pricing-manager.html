<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Manager — Universal Cellular</title>
    <link rel="stylesheet" href="styles/theme.css">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ── Loading Overlay ─────────────────────── */
        .loading-overlay {
            position: fixed; inset: 0;
            background: var(--bg-primary);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: var(--z-modal);
            transition: opacity 0.4s ease;
        }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: var(--space-4);
            font-size: var(--text-base);
            color: var(--text-secondary);
            font-weight: 500;
        }
        .loading-progress {
            margin-top: var(--space-3);
            width: 240px; height: 4px;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%; width: 0%;
            background: var(--accent);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }
        .loading-detail {
            margin-top: var(--space-2);
            font-size: var(--text-xs);
            color: var(--text-muted);
        }

        /* ── Compact Top Bar ────────────────────── */
        .top-bar {
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            padding: 0 var(--space-5);
            gap: var(--space-4);
            position: sticky;
            top: 52px;
            z-index: var(--z-sticky);
            backdrop-filter: blur(16px);
        }
        .top-bar-brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-shrink: 0;
        }
        .logo-wrap {
            position: relative;
            width: 32px; height: 32px;
            flex-shrink: 0;
        }
        .logo-wrap img {
            width: 32px; height: 32px;
            border-radius: var(--radius-md);
        }
        .sync-dot {
            position: absolute;
            bottom: -1px; right: -1px;
            width: 9px; height: 9px;
            border-radius: 50%;
            background: var(--positive);
            border: 2px solid var(--bg-card);
        }
        .sync-dot.stale { background: var(--warning); }
        .sync-dot.error { background: var(--negative); }
        .top-bar-title {
            font-size: var(--text-base);
            font-weight: 700;
            white-space: nowrap;
            line-height: 1;
        }
        .top-bar-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            white-space: nowrap;
            margin-top: 1px;
        }

        /* ── Search Bar (centered, prominent) ──── */
        .search-wrap {
            flex: 1;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
        }
        .search-wrap svg {
            position: absolute;
            left: 14px; top: 50%;
            transform: translateY(-50%);
            width: 16px; height: 16px;
            color: var(--text-muted);
            pointer-events: none;
        }
        .search-wrap input {
            width: 100%;
            height: 38px;
            padding: 0 14px 0 40px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            font-size: var(--text-sm);
            font-family: var(--font-display);
            background: var(--bg-secondary);
            color: var(--text-primary);
            outline: none;
            transition: all var(--transition-fast);
        }
        .search-wrap input::placeholder { color: var(--text-muted); }
        .search-wrap input:focus {
            border-color: var(--accent);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }

        /* ── Top Bar Actions ───────────────────── */
        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-shrink: 0;
        }
        .icon-btn {
            width: 36px; height: 36px;
            border-radius: var(--radius-md);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            position: relative;
        }
        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .icon-btn svg { width: 18px; height: 18px; }
        .icon-btn .badge {
            position: absolute;
            top: 2px; right: 2px;
            min-width: 16px; height: 16px;
            background: #6366f1;
            color: white;
            font-size: 9px;
            font-weight: 700;
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            line-height: 1;
        }
        .icon-btn .badge.visible { display: inline-flex; }
        .filter-btn.has-filters {
            background: var(--accent-subtle);
            color: var(--accent);
        }
        .separator {
            width: 1px;
            height: 24px;
            background: var(--border-subtle);
            margin: 0 6px;
        }
        .sync-text {
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ── Filter Popover ────────────────────── */
        .filter-popover-backdrop {
            position: fixed; inset: 0;
            z-index: calc(var(--z-sticky) + 10);
            display: none;
        }
        .filter-popover-backdrop.open { display: block; }
        .filter-popover {
            position: fixed;
            top: 110px;
            right: var(--space-5);
            width: 340px;
            max-height: calc(100vh - 80px);
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px -12px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.03);
            z-index: calc(var(--z-sticky) + 11);
            display: none;
            overflow: hidden;
            animation: popoverIn 0.15s ease;
        }
        .filter-popover.open { display: flex; flex-direction: column; }
        @keyframes popoverIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .filter-popover-header {
            padding: var(--space-4) var(--space-4) var(--space-3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-subtle);
        }
        .filter-popover-header h3 {
            font-size: var(--text-sm);
            font-weight: 700;
        }
        .filter-popover-body {
            padding: var(--space-3) var(--space-4);
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        .filter-section label {
            display: block;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
        }
        .filter-section select {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            outline: none;
        }
        .filter-section select:focus { border-color: var(--accent); }
        .chip-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .brand-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border-default);
            background: var(--bg-primary);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            user-select: none;
        }
        .brand-chip:hover { border-color: var(--text-muted); }
        .brand-chip.active {
            background: var(--accent-subtle);
            color: var(--accent);
            border-color: var(--accent);
        }
        .brand-chip .chip-count {
            font-size: 10px;
            opacity: 0.6;
        }
        .storage-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: var(--radius-full);
            font-size: 10px;
            font-weight: 600;
            font-family: var(--font-mono);
            cursor: pointer;
            border: 1px solid var(--border-default);
            background: var(--bg-primary);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            user-select: none;
        }
        .storage-chip:hover { border-color: var(--text-muted); }
        .storage-chip.active {
            background: var(--info-subtle);
            color: var(--info);
            border-color: var(--info);
        }
        .range-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .range-row input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-family: var(--font-mono);
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
            text-align: center;
        }
        .range-row input:focus { border-color: var(--accent); }
        .range-row .sep { color: var(--text-muted); font-size: var(--text-xs); }
        .filter-popover-footer {
            padding: var(--space-3) var(--space-4);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: var(--space-2);
            justify-content: flex-end;
        }
        .btn-sm {
            padding: 6px 14px;
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: var(--font-display);
            transition: all var(--transition-fast);
        }
        .btn-sm.ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-sm.ghost:hover { background: var(--bg-hover); }
        .btn-sm.primary {
            background: var(--accent);
            color: white;
        }
        .btn-sm.primary:hover { background: var(--accent-hover); }

        /* ── Active Filter Tags Strip ──────────── */
        .active-filters-strip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 var(--space-5);
            min-height: 0;
            overflow: hidden;
            transition: all var(--transition-fast);
            flex-wrap: wrap;
        }
        .active-filters-strip.has-filters {
            padding: 8px var(--space-5);
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
        }
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            background: var(--accent-subtle);
            color: var(--accent);
        }
        .filter-tag .remove-tag {
            cursor: pointer;
            opacity: 0.6;
            font-size: 13px;
            line-height: 1;
            margin-left: 2px;
        }
        .filter-tag .remove-tag:hover { opacity: 1; }
        .clear-all-btn {
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            background: none;
            border: none;
            font-family: var(--font-display);
            font-weight: 500;
            margin-left: 4px;
        }
        .clear-all-btn:hover { color: var(--accent); }

        /* ── Compact Stats Toolbar ─────────────── */
        .stats-toolbar {
            display: flex;
            align-items: center;
            gap: var(--space-5);
            padding: 10px var(--space-5);
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-card);
            flex-wrap: wrap;
        }
        .stat-pill {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        .stat-pill .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }
        .stat-pill .stat-value {
            font-size: 13px;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-primary);
        }
        .stat-pill .stat-value.positive { color: var(--positive); }
        .stat-pill .stat-value.warning { color: var(--warning); }
        .stat-pill .stat-value.negative { color: var(--negative); }
        .stat-dot {
            width: 3px; height: 3px;
            border-radius: 50%;
            background: var(--border-default);
            align-self: center;
        }
        .stats-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        .item-count {
            font-size: 11px;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        /* ── Error Banner ──────────────────────── */
        .error-banner {
            background: var(--negative-subtle);
            border: 1px solid var(--negative);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            margin: var(--space-3) var(--space-5);
            font-size: var(--text-sm);
            color: #991b1b;
            display: none;
        }
        /* light mode only */
        .error-banner.visible {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* ── Table Area ────────────────────────── */
        .table-area {
            padding: 0 var(--space-5) 52px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: var(--text-sm);
        }
        thead th {
            background: var(--bg-card);
            padding: 10px var(--space-3);
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border-default);
            position: sticky;
            top: 108px;
            z-index: 10;
            backdrop-filter: blur(12px);
        }
        thead th:first-child { padding-left: var(--space-4); }

        tbody tr {
            transition: background var(--transition-fast);
        }
        tbody tr:hover { background: var(--bg-hover); }
        tbody tr.selected { background: var(--accent-subtle); }

        tbody td {
            padding: 12px var(--space-3);
            border-bottom: 1px solid var(--border-subtle);
            vertical-align: middle;
        }
        tbody tr td:first-child {
            border-left: 3px solid transparent;
            padding-left: calc(var(--space-4) - 3px);
        }

        /* Brand color left border */
        tr.brand-apple td:first-child { border-left-color: #a3a3a3; }
        tr.brand-samsung td:first-child { border-left-color: #3b82f6; }
        tr.brand-google td:first-child { border-left-color: #34d399; }
        tr.brand-motorola td:first-child { border-left-color: #f59e0b; }
        tr.brand-lg td:first-child { border-left-color: #ef4444; }
        tr.brand-oneplus td:first-child { border-left-color: #ec4899; }
        tr.brand-tcl td:first-child { border-left-color: #8b5cf6; }
        tr.brand-other td:first-child { border-left-color: var(--border-default); }

        .cell-model {
            font-weight: 600;
            color: var(--text-primary);
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .cell-model-sub {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 1px;
        }
        .cell-storage {
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .cell-location { white-space: nowrap; font-size: 11px; }
        .loc-badge { display: inline-block; padding: 1px 5px; border-radius: 3px; font-weight: 600; font-family: var(--font-mono); }
        .loc-badge.loc-rr { background: rgba(34,197,94,0.15); color: #22c55e; }
        .loc-badge.loc-proc { background: rgba(234,179,8,0.15); color: #eab308; }

        /* Compact grade display */
        .grade-display {
            display: flex;
            gap: 6px;
            font-size: 11px;
            font-family: var(--font-mono);
        }
        .grade-item {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .grade-item .g-label {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 10px;
        }
        .grade-item.empty { opacity: 0.25; }

        .cell-total {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            text-align: center;
        }

        /* Price input — the hero element */
        .price-cell {
            text-align: center;
            min-width: 100px;
        }
        .grade-price-input {
            display: inline-flex;
            align-items: center;
            gap: 1px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 2px;
            transition: all var(--transition-fast);
        }
        .grade-price-input:focus-within {
            border-color: var(--accent);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px var(--accent-subtle);
        }
        .grade-price-input span {
            font-size: var(--text-sm);
            color: var(--text-muted);
            padding-left: 8px;
            font-weight: 500;
        }
        .grade-price-input input {
            width: 72px;
            padding: 6px 8px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: var(--font-mono);
            font-weight: 600;
            text-align: center;
            background: transparent;
            color: var(--text-primary);
            outline: none;
        }
        .grade-price-input input::placeholder { color: var(--text-muted); font-weight: 400; }
        .grade-price-input input.just-saved {
            animation: priceSaved 0.6s ease;
        }
        @keyframes priceSaved {
            0%, 100% { background: transparent; }
            30% { background: var(--positive-subtle); }
        }

        .cell-value {
            font-family: var(--font-mono);
            font-weight: 700;
            text-align: right;
            color: var(--positive);
            font-size: var(--text-sm);
        }
        .cell-value.no-value { color: var(--text-muted); font-weight: 400; }

        /* Status dot */
        .status-dot {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            vertical-align: middle;
        }
        .status-dot.priced { background: var(--positive); }
        .status-dot.stale { background: var(--warning); }
        .status-dot.unpriced { background: var(--border-default); }

        /* Deal add button (subtle, appears on hover) */
        .add-deal-btn {
            width: 26px; height: 26px;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            line-height: 1;
            transition: all var(--transition-fast);
            opacity: 0;
        }
        tbody tr:hover .add-deal-btn { opacity: 1; }
        .add-deal-btn:hover {
            background: var(--accent-subtle);
            color: var(--accent);
            border-color: var(--accent);
        }
        .hist-btn { background:none; border:none; cursor:pointer; font-size:14px; opacity:0.4; padding:2px 4px; transition:opacity 0.15s; }
        tbody tr:hover .hist-btn { opacity:0.8; }
        .hist-btn:hover { opacity:1; }
        .add-deal-btn.in-deal {
            opacity: 1;
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        /* Checkbox */
        .row-checkbox {
            width: 15px; height: 15px;
            accent-color: var(--accent);
            cursor: pointer;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        tbody tr:hover .row-checkbox,
        .row-checkbox:checked { opacity: 1; }
        thead .row-checkbox { opacity: 1; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            color: var(--text-muted);
        }
        .empty-state h3 {
            font-size: var(--text-lg);
            margin-bottom: var(--space-2);
            color: var(--text-secondary);
        }

        /* ── Minimal Footer ────────────────────── */
        .sticky-footer {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 40px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            padding: 0 var(--space-5);
            gap: var(--space-5);
            z-index: var(--z-sticky);
            backdrop-filter: blur(12px);
            font-size: 12px;
            color: var(--text-muted);
            transition: right var(--transition-slow);
        }
        .sticky-footer.panel-open { right: 420px; }
        .footer-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        .footer-item .val {
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--text-secondary);
        }
        .footer-item .val.positive { color: var(--positive); }
        .footer-sep {
            color: var(--border-default);
        }

        /* ── Deal Builder Panel ─────────────────── */
        .deal-panel {
            position: fixed;
            top: 0; right: -420px;
            width: 420px; height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-default);
            box-shadow: -8px 0 30px -12px rgba(0,0,0,0.1);
            z-index: calc(var(--z-sticky) + 5);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        .deal-panel.open { right: 0; }
        body.deal-open .header,
        body.deal-open .top-bar,
        body.deal-open .active-filters-strip,
        body.deal-open .stats-toolbar,
        body.deal-open .table-area {
            margin-right: 420px;
        }
        body.deal-open .sticky-footer { right: 420px; }

        .deal-panel-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .deal-panel-header h2 {
            font-size: var(--text-base);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .deal-panel-fields {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            flex-shrink: 0;
        }
        .deal-field label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            display: block;
            margin-bottom: 4px;
        }
        .deal-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
        }
        .deal-field input:focus { border-color: var(--accent); }

        /* Deal Maker Search Section */
        .deal-add-section { padding: 0 var(--space-5) var(--space-3); border-bottom: 1px solid var(--border-subtle); }
        .deal-add-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
        .deal-search-wrap { position: relative; margin-bottom: 8px; }
        .deal-search-wrap input { width: 100%; padding: 8px 10px; border: 1px solid var(--border-default); border-radius: 6px; font-size: 13px; background: var(--bg-primary); color: var(--text-primary); font-family: inherit; }
        .deal-search-wrap input:focus { outline: none; border-color: var(--accent); }
        .deal-search-dropdown { position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 6px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 60; display: none; margin-top: 2px; }
        .deal-search-dropdown.visible { display: block; }
        .deal-search-opt { padding: 8px 10px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-subtle); }
        .deal-search-opt:last-child { border-bottom: none; }
        .deal-search-opt:hover { background: var(--bg-secondary); }
        .deal-search-opt .ds-name { font-weight: 500; }
        .deal-search-opt .ds-meta { font-size: 11px; color: var(--text-secondary); }
        .deal-search-opt .ds-colors { font-size: 10px; color: var(--text-muted); margin-top: 1px; }
        .deal-search-opt .ds-stock { font-size: 11px; color: var(--text-secondary); font-weight: 600; }
        .deal-add-row { margin-bottom: 8px; }
        .deal-add-selected { font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 6px; }
        .deal-add-stock { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
        .deal-chip-section { margin-bottom: 8px; }
        .deal-chip-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
        .deal-chip-row { display: flex; flex-wrap: wrap; gap: 5px; }
        .deal-chip { padding: 4px 10px; border-radius: 16px; font-size: 12px; font-weight: 500; cursor: pointer; border: 2px solid var(--border-default); background: var(--bg-primary); color: var(--text-primary); transition: all 0.15s; user-select: none; }
        .deal-chip:hover { border-color: var(--accent); }
        .deal-chip.selected { border-color: var(--accent); background: var(--accent); color: #fff; }
        .deal-chip.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .deal-chip .dc-count { font-size: 10px; opacity: 0.7; margin-left: 3px; }
        .deal-add-fields { display: flex; gap: 6px; align-items: end; }
        .deal-add-field { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .deal-add-field label { font-size: 10px; color: var(--text-muted); font-weight: 600; }
        .deal-add-field select, .deal-add-field input { padding: 6px 8px; border: 1px solid var(--border-default); border-radius: 5px; font-size: 12px; background: var(--bg-primary); color: var(--text-primary); font-family: inherit; }
        .deal-add-field select:focus, .deal-add-field input:focus { outline: none; border-color: var(--accent); }
        .deal-add-confirm { width: 100%; padding: 10px 16px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: all 0.15s; font-family: var(--font-display); }
        .deal-add-confirm:hover { filter: brightness(1.1); }
        .deal-add-confirm:disabled { opacity: 0.3; cursor: not-allowed; filter: none; }
        .deal-add-preview { font-size: 11px; color: var(--text-secondary); margin-top: 6px; font-family: var(--font-mono); font-weight: 600; }
        .deal-add-preview .preview-total { color: var(--positive); }

        .deal-items-header {
            padding: 10px var(--space-5);
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }
        .deal-items-list {
            flex: 1;
            overflow-y: auto;
        }
        .deal-item {
            padding: var(--space-3) var(--space-5);
            border-bottom: 1px solid var(--border-subtle);
            transition: background var(--transition-fast);
        }
        .deal-item:hover { background: var(--bg-hover); }
        .deal-item-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .deal-item-name {
            font-size: var(--text-sm);
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 260px;
        }
        .deal-item-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 16px;
            width: 24px; height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }
        .deal-item-remove:hover {
            background: var(--negative-subtle);
            color: var(--negative);
        }
        .deal-item-details {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-top: 6px;
            font-size: var(--text-xs);
        }
        .deal-item-details .avail {
            color: var(--text-muted);
            flex-shrink: 0;
        }
        .deal-item-details input {
            width: 52px;
            padding: 4px 6px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-family: var(--font-mono);
            text-align: center;
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
        }
        .deal-item-details input:focus { border-color: var(--accent); }
        .deal-item-subtotal {
            margin-left: auto;
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--positive);
            font-size: var(--text-xs);
        }
        .deal-summary {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--border-default);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }
        .deal-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: var(--text-sm);
        }
        .deal-summary-row .label { color: var(--text-secondary); }
        .deal-summary-row .val {
            font-weight: 700;
            font-family: var(--font-mono);
        }
        .deal-summary-row.total {
            font-size: var(--text-base);
            border-top: 1px solid var(--border-default);
            padding-top: var(--space-2);
            margin-top: var(--space-1);
        }
        .deal-summary-row.total .val { color: var(--positive); }
        .deal-actions {
            padding: var(--space-3) var(--space-5);
            padding-bottom: calc(var(--space-3) + 44px);
            display: flex;
            gap: var(--space-2);
            border-top: 1px solid var(--border-subtle);
            flex-shrink: 0;
            position: relative;
            z-index: calc(var(--z-sticky) + 10);
        }
        .deal-actions .btn {
            flex: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: 10px 12px;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: var(--font-display);
            transition: all var(--transition-fast);
        }
        .deal-actions .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
        }
        .deal-actions .btn-secondary:hover { background: var(--bg-hover); }
        .deal-actions .btn-primary {
            background: var(--accent);
            color: white;
        }
        .deal-actions .btn-primary:hover { background: var(--accent-hover); }
        .deal-actions .btn svg { width: 16px; height: 16px; }
        .deal-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: var(--space-8);
        }
        .deal-empty svg {
            width: 40px; height: 40px;
            margin-bottom: var(--space-3);
            opacity: 0.25;
        }
        .deal-empty p { font-size: var(--text-sm); }

        /* ── Past Deals ────────────────────────── */
        .deal-history-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: var(--space-3) var(--space-4);
        }
        .past-deals-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            width: calc(100% - 32px);
            margin: 0 var(--space-4);
            padding: 8px 12px;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }
        .past-deals-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .past-deals-count {
            font-size: 11px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: auto;
        }
        .past-deals-count:empty { display: none; }
        .past-deals-list {
            margin: var(--space-2) var(--space-4) var(--space-4);
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .past-deal-card {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.15s;
        }
        .past-deal-card:hover { border-color: var(--accent); background: var(--bg-hover); }
        .past-deal-card .pd-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .past-deal-card .pd-name {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--text-primary);
        }
        .past-deal-card .pd-date {
            font-size: 11px;
            color: var(--text-muted);
        }
        .past-deal-card .pd-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
        }
        .past-deal-card .pd-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        .past-deal-card .pd-btn {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
        }
        .past-deal-card .pd-btn:hover { background: var(--bg-hover); }
        .past-deal-card .pd-btn.danger { color: var(--danger); }
        .past-deal-card .pd-btn.danger:hover { background: rgba(239,68,68,0.08); }
        .past-deals-empty {
            text-align: center;
            padding: 16px;
            font-size: var(--text-sm);
            color: var(--text-muted);
        }

        /* ── Modals ─────────────────────────────── */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000 !important;
            padding: var(--space-6);
        }
        .modal-overlay.visible { display: flex !important; }
        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        .modal-header {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h2 { font-size: var(--text-lg); font-weight: 700; }
        .modal-body { padding: var(--space-5) var(--space-6); }
        .modal-footer {
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-family: var(--font-display);
            transition: all var(--transition-fast);
        }
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover { background: var(--bg-hover); }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn svg { width: 16px; height: 16px; }
        .form-group { margin-bottom: var(--space-4); }
        .form-group label {
            display: block;
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
        }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent); }
        .form-group textarea { min-height: 60px; resize: vertical; }
        .export-preview {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            font-size: var(--text-sm);
        }
        .export-preview-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-1) 0;
        }
        .export-preview-row .label { color: var(--text-secondary); }
        .export-preview-row .value { font-weight: 600; font-family: var(--font-mono); }

        /* ── Toast ────────────────────────────────── */
        .toast-container {
            position: fixed;
            bottom: 52px;
            right: var(--space-5);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        .toast {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 10px 16px;
            font-size: var(--text-sm);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            animation: toastIn 0.25s ease;
        }
        .toast.success { border-left: 3px solid var(--positive); }
        .toast.error { border-left: 3px solid var(--negative); }
        @keyframes toastIn {
            from { transform: translateY(12px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ── Responsive ──────────────────────────── */
        @media (max-width: 900px) {
            .top-bar { padding: 0 var(--space-3); gap: var(--space-2); }
            .search-wrap { max-width: 240px; }
            .table-area { padding: 0 var(--space-3) 52px; }
            .deal-panel { width: 100%; right: -100%; }
            body.deal-open .header,
            body.deal-open .top-bar,
            body.deal-open .active-filters-strip,
            body.deal-open .stats-toolbar,
            body.deal-open .table-area { margin-right: 0; }
            body.deal-open .sticky-footer { right: 0; }
            .stats-toolbar { gap: var(--space-3); }
            .sync-text { display: none; }
        }
        @media (max-width: 600px) {
            .top-bar-title { display: none; }
            .search-wrap { max-width: 100%; }
            .stats-toolbar { display: none; }
        }

        /* ── Print ───────────────────────────────── */
        @media print {
            .header, .top-bar, .active-filters-strip, .stats-toolbar, .toast-container, .loading-overlay, .sticky-footer, .deal-panel, .filter-popover, .filter-popover-backdrop { display: none !important; }
            tbody tr { page-break-inside: avoid; }
            .grade-price-input { border: none !important; background: none !important; box-shadow: none !important; }
            .grade-price-input input { border: none !important; }
            .row-checkbox, .add-deal-btn { display: none !important; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading inventory...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingBar"></div>
        </div>
        <div class="loading-detail" id="loadingDetail">Preparing...</div>
    </div>

    <!-- ═══ Global Navigation ═══ -->
    <header class="header no-print">
        <div class="header-inner">
            <div class="header-brand">
                <div class="header-logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </div>
                <div>
                    <div class="header-title">Universal</div>
                    <div class="header-subtitle">Executive Dashboard</div>
                </div>
            </div>

            <nav class="header-nav">
                <a href="dashboard_standalone.html" class="nav-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="data-manager.html" class="nav-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                    </svg>
                    Data Manager
                </a>
                <a href="pricing-manager.html" class="nav-link active">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Pricing
                </a>
                <a href="marketing.html" class="nav-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                    Marketing
                </a>
            </nav>

            <div class="header-actions"></div>
        </div>
    </header>

    <!-- hidden sync elements for JS compatibility -->
    <span id="syncDot" style="display:none"></span>
    <span id="syncText" style="display:none"></span>

    <!-- ═══ Compact Top Bar ═══ -->
    <header class="top-bar">
        <div class="search-wrap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="searchInput" placeholder="Search models, storage..." oninput="onFilterChange()">
        </div>

        <div class="top-bar-actions">
            <span class="sync-text" id="itemCountBadge"></span>
            <div class="separator"></div>

            <!-- Filter Toggle -->
            <button class="icon-btn filter-btn" id="filterToggleBtn" onclick="toggleFilterPopover()" title="Filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            </button>

            <!-- Upload -->
            <button class="icon-btn" onclick="openUploadModal()" title="Upload pricing sheet">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </button>

            <div class="separator"></div>

            <!-- Past Deals -->
            <button class="icon-btn" id="pastDealsToggleBtn" onclick="openPastDealsModal()" title="Past Deals">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span class="badge" id="pastDealsCount"></span>
            </button>

            <!-- Deal Builder -->
            <button class="icon-btn" id="dealToggleBtn" onclick="toggleDealPanel()" title="New Deal">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                <span class="badge" id="dealBadge">0</span>
            </button>
        </div>
    </header>

    <!-- ═══ Filter Popover ═══ -->
    <div class="filter-popover-backdrop" id="filterBackdrop" onclick="closeFilterPopover()"></div>
    <div class="filter-popover" id="filterPopover">
        <div class="filter-popover-header">
            <h3>Filters</h3>
            <button class="btn-sm ghost" onclick="closeFilterPopover()" style="font-size:16px;padding:4px 8px;">&times;</button>
        </div>
        <div class="filter-popover-body">
            <div class="filter-section">
                <label>Status</label>
                <select id="statusFilter" onchange="onFilterChange()">
                    <option value="all">All Items</option>
                    <option value="unpriced">Unpriced Only</option>
                    <option value="priced">Priced</option>
                    <option value="stale">Stale Prices (7+ days)</option>
                </select>
            </div>
            <div class="filter-section">
                <label>Sort By</label>
                <select id="sortSelect" onchange="onSortChange()">
                    <option value="model-asc">Model A-Z</option>
                    <option value="model-desc">Model Z-A</option>
                    <option value="total-desc">Qty: High to Low</option>
                    <option value="total-asc">Qty: Low to High</option>
                    <option value="value-desc">Value: High to Low</option>
                    <option value="value-asc">Value: Low to High</option>
                    <option value="status-asc">Unpriced First</option>
                    <!-- location sort removed -->
                </select>
            </div>
            <div class="filter-section">
                <label>Brands</label>
                <div class="chip-grid" id="brandChips"></div>
            </div>
            <div class="filter-section">
                <label>Storage</label>
                <div class="chip-grid" id="storageChips"></div>
            </div>
            <div class="filter-section">
                <label>Location</label>
                <div class="chip-grid" id="locationChips"></div>
            </div>
            <div class="filter-section">
                <label>Price Range ($)</label>
                <div class="range-row">
                    <input type="number" id="priceMin" placeholder="Min" min="0" oninput="onFilterChange()">
                    <span class="sep">&mdash;</span>
                    <input type="number" id="priceMax" placeholder="Max" min="0" oninput="onFilterChange()">
                </div>
            </div>
            <div class="filter-section">
                <label>Quantity Range</label>
                <div class="range-row">
                    <input type="number" id="qtyMin" placeholder="Min" min="0" oninput="onFilterChange()">
                    <span class="sep">&mdash;</span>
                    <input type="number" id="qtyMax" placeholder="Max" min="0" oninput="onFilterChange()">
                </div>
            </div>
            <div class="filter-section">
                <label>Quick Presets</label>
                <select id="presetFilter" onchange="applyPreset()">
                    <option value="">Choose a preset...</option>
                    <option value="iphones">All iPhones</option>
                    <option value="ipads">All iPads</option>
                    <option value="samsung">All Samsung</option>
                    <option value="highvalue">High-Value ($500+)</option>
                    <option value="bulk">Bulk Items (10+ units)</option>
                    <option value="unpriced">Unpriced Only</option>
                </select>
            </div>
        </div>
        <div class="filter-popover-footer">
            <button class="btn-sm ghost" onclick="clearAllFilters()">Clear All</button>
            <button class="btn-sm primary" onclick="closeFilterPopover()">Done</button>
        </div>
    </div>

    <!-- ═══ Active Filter Tags ═══ -->
    <div class="active-filters-strip" id="activeFiltersStrip">
        <div id="activeFilters" style="display:contents;"></div>
    </div>

    <!-- ═══ Compact Stats Toolbar ═══ -->
    <div class="stats-toolbar">
        <div class="stat-pill">
            <span class="stat-label">Models</span>
            <span class="stat-value" id="statModels">--</span>
        </div>
        <span class="stat-dot"></span>
        <div class="stat-pill">
            <span class="stat-label">Units</span>
            <span class="stat-value" id="statUnits">--</span>
        </div>
        <span class="stat-dot"></span>
        <div class="stat-pill">
            <span class="stat-label">Priced</span>
            <span class="stat-value positive" id="statPriced">--</span>
        </div>
        <span class="stat-dot"></span>
        <div class="stat-pill">
            <span class="stat-label">Unpriced</span>
            <span class="stat-value negative" id="statUnpriced">--</span>
        </div>
        <span class="stat-dot"></span>
        <div class="stat-pill">
            <span class="stat-label">Value</span>
            <span class="stat-value" id="statValue">--</span>
        </div>

        <div class="stats-right">
            <span class="item-count" id="filteredCount"></span>
            <button class="btn-sm primary" onclick="exportCatalog()" style="margin-left:8px;display:inline-flex;align-items:center;gap:4px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export Catalog
            </button>
        </div>
    </div>

    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner">
        <span id="errorText"></span>
        <button class="btn btn-ghost" onclick="document.getElementById('errorBanner').classList.remove('visible')" style="margin-left:auto;font-size:var(--text-xs);">Dismiss</button>
    </div>

    <!-- ═══ Pricing Table ═══ -->
    <div class="table-area" id="tableWrap">
        <table>
            <thead>
                <tr>
                    <th style="width:32px;"><input type="checkbox" id="selectAll" class="row-checkbox" onchange="toggleSelectAll()"></th>
                    <th>Model</th>
                    <th>Storage</th>
                    <th>Grades</th>
                    <th style="text-align:center;">Qty</th>
                    <th style="text-align:center;">Price</th>
                    <th style="text-align:center;">Avg Cost</th>
                    <th style="text-align:right;">Value</th>
                    <th style="text-align:center;width:36px;" title="Status"></th>
                    <th style="text-align:center;width:36px;" title="Deal"></th>
                    <th style="text-align:center;width:36px;" title="History"></th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
        <div class="empty-state" id="emptyState" style="display:none;">
            <h3>No items match your filters</h3>
            <p>Try adjusting your search or filter criteria.</p>
        </div>
    </div>

    <!-- ═══ Minimal Footer ═══ -->
    <div class="sticky-footer" id="stickyFooter">
        <div class="footer-item">
            Showing <span class="val" id="footerShowing">0</span>
        </div>
        <span class="footer-sep">&middot;</span>
        <div class="footer-item">
            <span class="val" id="footerUnits">0</span> units
        </div>
        <span class="footer-sep">&middot;</span>
        <div class="footer-item">
            <span class="val positive" id="footerValue">$0</span>
        </div>
        <div class="footer-item" style="margin-left:auto;">
            <span class="val" id="footerSelected">0</span> selected
        </div>
    </div>

    <!-- ═══ Deal Builder Panel ═══ -->
    <div class="deal-panel" id="dealPanel">
        <div class="deal-panel-header">
            <h2>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                Deal Builder
            </h2>
            <button class="btn-sm ghost" onclick="closeDealPanel()" style="font-size:18px;">&times;</button>
        </div>
        <!-- Deal name/buyer moved to proceed modal -->

        <!-- Deal Search + Add -->
        <div class="deal-add-section">
            <div class="deal-add-label">Add Item</div>
            <div class="deal-search-wrap">
                <input type="text" id="dealModelSearch" placeholder="Search model..." autocomplete="off" oninput="onDealSearch()" onfocus="onDealSearch()">
                <div class="deal-search-dropdown" id="dealSearchDropdown"></div>
            </div>
            <div class="deal-add-row" id="dealAddRow" style="display:none;">
                <div class="deal-add-selected" id="dealAddSelected"></div>
                <div class="deal-add-stock" id="dealAddStock"></div>
                <div class="deal-chip-section">
                    <div class="deal-chip-label">Grade</div>
                    <div class="deal-chip-row" id="dealGradeChips"></div>
                </div>
                <div class="deal-chip-section">
                    <div class="deal-chip-label">Color</div>
                    <div class="deal-chip-row" id="dealColorChips"></div>
                </div>
                <div class="deal-add-fields" style="margin-top:8px;">
                    <div class="deal-add-field">
                        <label>Qty</label>
                        <input type="number" id="dealQtyInput" min="1" value="1" oninput="updateDealPreview()">
                    </div>
                    <div class="deal-add-field">
                        <label>Price</label>
                        <input type="number" id="dealPriceInput" min="0" step="1" placeholder="$" oninput="updateDealPreview()">
                    </div>
                </div>
                <div class="deal-add-preview" id="dealAddPreview"></div>
                <button class="deal-add-confirm" id="dealAddBtn" onclick="addDealSearchItem()" disabled>Add to Deal</button>
                <!-- Hidden selects for compatibility -->
                <select id="dealGradeSelect" style="display:none;"></select>
                <select id="dealColorSelect" style="display:none;"></select>
            </div>
        </div>

        <div class="deal-items-header" id="dealItemsHeader">Items (0)</div>
        <div class="deal-items-list" id="dealItemsList">
            <div class="deal-empty" id="dealEmpty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                <p>Search a model above or click <strong>+</strong> on any table row.</p>
            </div>
        </div>
        <div class="deal-summary" id="dealSummary" style="display:none;">
            <div class="deal-summary-row">
                <span class="label">Models</span>
                <span class="val" id="dealSumModels">0</span>
            </div>
            <div class="deal-summary-row">
                <span class="label">Total Units</span>
                <span class="val" id="dealSumUnits">0</span>
            </div>
            <div class="deal-summary-row total">
                <span class="label">Total Value</span>
                <span class="val" id="dealSumValue">$0</span>
            </div>
        </div>
        <div class="deal-actions" id="dealActions" style="display:none;">
            <button class="btn btn-secondary" onclick="clearDeal()">Clear</button>
            <button class="btn btn-primary" id="proceedBtn" style="flex:2;pointer-events:auto;position:relative;z-index:9999;">
                Proceed →
            </button>
        </div>
    </div>

    <!-- ═══ Past Deals Modal ═══ -->
    <div class="modal-overlay" id="pastDealsModal" onclick="if(event.target===this)closePastDealsModal()">
        <div class="modal" style="max-width:600px;max-height:80vh;">
            <div class="modal-header">
                <h3>Past Deals</h3>
                <button class="btn-sm ghost" onclick="closePastDealsModal()" style="font-size:18px;">&times;</button>
            </div>
            <div class="modal-body" id="pastDealsModalBody" style="overflow-y:auto;max-height:60vh;padding:16px;">
                <div class="past-deals-empty">Loading...</div>
            </div>
        </div>
    </div>

    <!-- ═══ Upload Modal ═══ -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Upload Priced Sheet</h2>
                <button class="btn btn-ghost" onclick="closeUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:var(--text-sm);color:var(--text-secondary);margin-bottom:var(--space-4);">
                    Upload your Excel sheet with a <strong>PRICE</strong> column. We'll read READY BREAKDOWN and PRO BREAKDOWN tabs and import prices by model + storage.
                </p>
                <div id="dropZone" style="border:2px dashed var(--border-default);border-radius:var(--radius-lg);padding:var(--space-8) var(--space-4);text-align:center;cursor:pointer;transition:all var(--transition-fast);"
                     onclick="document.getElementById('fileInput').click()"
                     ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='var(--accent-subtle)'"
                     ondragleave="this.style.borderColor='var(--border-default)';this.style.background='transparent'"
                     ondrop="event.preventDefault();this.style.borderColor='var(--border-default)';this.style.background='transparent';handleFileDrop(event.dataTransfer.files)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:36px;height:36px;margin:0 auto var(--space-3);display:block;color:var(--text-muted);"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke-linecap="round" stroke-linejoin="round"/><polyline points="17 8 12 3 7 8" stroke-linecap="round" stroke-linejoin="round"/><line x1="12" y1="3" x2="12" y2="15" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <div style="font-weight:600;color:var(--text-secondary);">Drop .xlsx file here or click to browse</div>
                    <div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:var(--space-1);">Supports UNICEL STOCK BREAKDOWN format</div>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleFileDrop(this.files)">
                <div id="uploadResult" style="display:none;margin-top:var(--space-4);"></div>
            </div>
            <div class="modal-footer" id="uploadFooter" style="display:none;">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmImportBtn" onclick="confirmImport()">Import Prices</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Export Offer Sheet</h2>
                <button class="btn btn-ghost" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="buyerName">Buyer Name (optional)</label>
                    <input type="text" id="buyerName" placeholder="e.g. ABC Wireless">
                </div>
                <div class="form-group">
                    <label for="offerNotes">Notes (optional)</label>
                    <textarea id="offerNotes" placeholder="Payment terms, shipping notes..."></textarea>
                </div>
                <div class="export-preview" id="exportPreview">
                    <div class="export-preview-row">
                        <span class="label">Models included</span>
                        <span class="value" id="previewModels">0</span>
                    </div>
                    <div class="export-preview-row">
                        <span class="label">Total units</span>
                        <span class="value" id="previewUnits">0</span>
                    </div>
                    <div class="export-preview-row">
                        <span class="label">Total value</span>
                        <span class="value" id="previewValue">$0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="downloadExport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download Excel
                </button>
            </div>
        </div>
    </div>

    <!-- ═══ Proceed / Finalize Deal Modal ═══ -->
    <div class="modal-overlay" id="proceedModal" style="display:none;" onclick="if(event.target===this)closeProceedModal()">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <h2>Finalize Deal</h2>
                <button class="btn btn-ghost" onclick="closeProceedModal()" style="font-size:18px;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dealName">Deal Name</label>
                    <input type="text" id="dealName" placeholder="e.g. Q1 Bulk Order">
                </div>
                <div class="form-group">
                    <label for="dealBuyer">Buyer</label>
                    <input type="text" id="dealBuyer" placeholder="e.g. ABC Wireless">
                </div>
                <div class="export-preview" id="proceedPreview" style="margin-top:16px;">
                    <div class="export-preview-row">
                        <span class="label">Line Items</span>
                        <span class="value" id="proceedItems">0</span>
                    </div>
                    <div class="export-preview-row">
                        <span class="label">Total Units</span>
                        <span class="value" id="proceedUnits">0</span>
                    </div>
                    <div class="export-preview-row">
                        <span class="label">Total Value</span>
                        <span class="value" id="proceedValue">$0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display:flex;gap:8px;">
                <button class="btn btn-secondary" onclick="closeProceedModal()">Back</button>
                <button class="btn btn-secondary" onclick="saveDealFromModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save
                </button>
                <button class="btn btn-primary" onclick="exportDealFromModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- External Scripts -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="wholecell-transformer.js"></script>
    <script src="pricing-db.js"></script>
    <script src="scripts/theme-switcher.js"></script>

    <script>
    /* ══════════════════════════════════════════════════════════
       BRAND DETECTION
       ══════════════════════════════════════════════════════════ */
    const BRAND_RULES = [
        { keywords: ['IPHONE'],                     brand: 'Apple',    type: 'Phone'  },
        { keywords: ['IPAD'],                       brand: 'Apple',    type: 'Tablet' },
        { keywords: ['APPLE WATCH'],                brand: 'Apple',    type: 'Watch'  },
        { keywords: ['MACBOOK', 'AIRPODS'],         brand: 'Apple',    type: 'Other'  },
        { keywords: ['GALAXY', 'SAMSUNG'],          brand: 'Samsung',  type: 'Phone'  },
        { keywords: ['PIXEL'],                      brand: 'Google',   type: 'Phone'  },
        { keywords: ['MOTO', 'G STYLUS', 'G POWER', 'RAZR'], brand: 'Motorola', type: 'Phone' },
        { keywords: ['LG'],                         brand: 'LG',       type: 'Phone'  },
        { keywords: ['ONEPLUS', 'ONE PLUS'],        brand: 'OnePlus',  type: 'Phone'  },
        { keywords: ['TCL'],                        brand: 'TCL',      type: 'Phone'  },
        { keywords: ['GALAXY TAB', 'GALAXY BOOK'],  brand: 'Samsung',  type: 'Tablet' },
    ];

    function detectBrand(modelName) {
        const upper = (modelName || '').toUpperCase();
        for (let i = BRAND_RULES.length - 1; i >= 0; i--) {
            const rule = BRAND_RULES[i];
            for (const kw of rule.keywords) {
                if (upper.includes(kw)) return { brand: rule.brand, type: rule.type };
            }
        }
        return { brand: 'Other', type: 'Phone' };
    }

    function brandClass(brand) {
        return 'brand-' + brand.toLowerCase().replace(/[^a-z]/g, '');
    }

    /* ══════════════════════════════════════════════════════════
       STATE
       ══════════════════════════════════════════════════════════ */
    let inventoryGroups = [];
    let filteredGroups = [];
    let selectedRows = new Set();
    let lastSyncTime = null;
    let refreshTimer = null;
    let pendingImport = null;
    const STALE_DAYS = 7;
    const REFRESH_INTERVAL = 15 * 60 * 1000;

    let activeBrands = new Set();
    let activeStorages = new Set();
    let activeLocations = new Set();
    let allBrands = {};
    let allStorages = {};

    let dealItems = new Map();
    let dealPanelOpen = false;

    /* ══════════════════════════════════════════════════════════
       INIT
       ══════════════════════════════════════════════════════════ */
    document.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
        showLoading(true, 'Initializing...');
        loadDealState();
        // Fetch past deals count in background
        fetch('/api/deals').then(r=>r.json()).then(d=>{
            if(d.deals&&d.deals.length>0) document.getElementById('pastDealsCount').textContent=d.deals.length;
        }).catch(()=>{});
        try {
            await pricingDB.ensureReady();
            await loadInventory();
            startAutoRefresh();
        } catch (err) {
            console.error('Init failed:', err);
            showError('Failed to load inventory: ' + err.message);
            showLoading(false);
        }
    }

    /* ══════════════════════════════════════════════════════════
       DATA LOADING
       ══════════════════════════════════════════════════════════ */
    const PROXY_URL = 'http://localhost:5001';

    async function fetchByLocation(location, onProgress, startPage, totalEstimate, status) {
        const allItems = [];
        const st = status || 'Available';
        const firstUrl = `${PROXY_URL}/api/inventory?status=${encodeURIComponent(st)}&location=${encodeURIComponent(location)}&page=1`;
        const resp = await fetch(firstUrl);
        const first = await resp.json();
        if (!first.data) return allItems;
        const totalPages = first.pages || 1;
        allItems.push(...first.data);
        if (onProgress) onProgress(startPage + 1, totalEstimate || totalPages);
        for (let p = 2; p <= totalPages; p++) {
            const url = `${PROXY_URL}/api/inventory?status=${encodeURIComponent(st)}&location=${encodeURIComponent(location)}&page=${p}`;
            try { const r = await fetch(url); const d = await r.json(); if (d.data) allItems.push(...d.data); }
            catch (e) { console.warn(`Page ${p} failed for ${location}:`, e.message); }
            if (onProgress) onProgress(startPage + p, totalEstimate);
            if (p < totalPages) await new Promise(r => setTimeout(r, 500));
        }
        return allItems;
    }

    async function fetchPricingInventory(onProgress) {
        // Fetch all locations for Available status + Inbound status
        const fetchTargets = [
            { status: 'Available', location: 'Ready Room' },
            { status: 'Available', location: 'Processing' },
            { status: 'Available', location: 'Receiving' },
            { status: 'Available', location: 'Damaged' },
            { status: 'Available', location: 'Locked' },
            { status: 'Inbound', location: 'Inbound' },
        ];
        // Peek all to get total pages
        const peeks = await Promise.all(fetchTargets.map(t =>
            fetch(`${PROXY_URL}/api/inventory?status=${encodeURIComponent(t.status)}&location=${encodeURIComponent(t.location)}&page=1`)
                .then(r => r.json()).catch(() => ({ pages: 0, data: [] }))
        ));
        const pageCounts = peeks.map(p => p.pages || 0);
        const totalPages = pageCounts.reduce((a, b) => a + b, 0);
        if (onProgress) onProgress(0, totalPages);

        let allItems = [];
        let pageOffset = 0;
        for (let i = 0; i < fetchTargets.length; i++) {
            if (pageCounts[i] > 0) {
                const items = await fetchByLocation(fetchTargets[i].location, onProgress, pageOffset, totalPages,
                    fetchTargets[i].status);
                allItems.push(...items);
            }
            pageOffset += pageCounts[i];
        }
        return allItems;
    }

    const PRICING_CACHE_KEY = 'pricing_manager_cache';
    const PRICING_CACHE_TS_KEY = 'pricing_manager_cache_ts';
    const CACHE_MAX_AGE = 10 * 60 * 1000;

    function getCachedPricingData() {
        try {
            const ts = localStorage.getItem(PRICING_CACHE_TS_KEY);
            if (!ts || Date.now() - parseInt(ts) > CACHE_MAX_AGE) return null;
            const d = localStorage.getItem(PRICING_CACHE_KEY);
            return d ? JSON.parse(d) : null;
        } catch { return null; }
    }
    function savePricingCache(raw) {
        try { localStorage.setItem(PRICING_CACHE_KEY, JSON.stringify(raw)); localStorage.setItem(PRICING_CACHE_TS_KEY, String(Date.now())); }
        catch (e) { console.warn('Cache save failed:', e.message); }
    }

    async function loadInventory() {
        showLoading(true, 'Checking cache...');
        const cached = getCachedPricingData();
        if (cached && cached.length > 0) {
            document.getElementById('loadingDetail').textContent = `Loading ${cached.length.toLocaleString()} cached items...`;
            const items = WholecellTransformer.transformAll(cached);
            inventoryGroups = groupInventory(items);
            await mergeWithPrices();
            lastSyncTime = new Date(parseInt(localStorage.getItem(PRICING_CACHE_TS_KEY)));
            buildFilterChips();
            updateSyncInfo(); applyFiltersAndRender(); updateStats(); showLoading(false);
            // silently loaded from cache
            backgroundSync();
            return;
        }

        // Try local JSON snapshot first (no proxy needed)
        showLoading(true, 'Loading data...');
        try {
            const snapResp = await fetch('data/available-inventory.json');
            if (snapResp.ok) {
                const snapData = await snapResp.json();
                if (snapData.data && snapData.data.length > 0) {
                    const rawItems = snapData.data;
                    savePricingCache(rawItems);
                    const items = WholecellTransformer.transformAll(rawItems);
                    inventoryGroups = groupInventory(items);
                    await mergeWithPrices();
                    lastSyncTime = snapData.metadata?.timestamp ? new Date(snapData.metadata.timestamp) : new Date();
                    buildFilterChips();
                    updateSyncInfo(); applyFiltersAndRender(); updateStats(); showLoading(false);
                    // silently loaded
                    return;
                }
            }
        } catch (e) {
            console.warn('Local snapshot not available:', e.message);
        }

        // Fallback to proxy
        showLoading(true, 'Fetching Ready Room + Processing...');
        document.getElementById('loadingDetail').textContent = 'Loading...';
        const rawItems = await fetchPricingInventory((cur, tot) => {
            const pct = Math.round((cur / tot) * 100);
            document.getElementById('loadingBar').style.width = pct + '%';
            document.getElementById('loadingDetail').textContent = `Page ${cur} of ${tot} (${pct}%)`;
        });
        showLoading(true, 'Processing...'); savePricingCache(rawItems);
        const items = WholecellTransformer.transformAll(rawItems);
        inventoryGroups = groupInventory(items);
        await mergeWithPrices();
        lastSyncTime = new Date();
        buildFilterChips();
        updateSyncInfo(); applyFiltersAndRender(); updateStats(); showLoading(false);
        showToast(`Loaded ${inventoryGroups.length} model groups`, 'success');
    }

    async function backgroundSync() {
        try {
            const raw = await fetchPricingInventory(null); savePricingCache(raw);
            const items = WholecellTransformer.transformAll(raw);
            inventoryGroups = groupInventory(items); await mergeWithPrices();
            lastSyncTime = new Date();
            buildFilterChips();
            updateSyncInfo(); applyFiltersAndRender(); updateStats();
        } catch (e) { console.warn('Background sync failed:', e.message); }
    }

    async function refreshData() {
        try {
            showToast('Refreshing...'); localStorage.removeItem(PRICING_CACHE_KEY); localStorage.removeItem(PRICING_CACHE_TS_KEY);
            const raw = await fetchPricingInventory(null); savePricingCache(raw);
            const items = WholecellTransformer.transformAll(raw);
            inventoryGroups = groupInventory(items); await mergeWithPrices();
            lastSyncTime = new Date();
            buildFilterChips();
            updateSyncInfo(); applyFiltersAndRender(); updateStats();
            showToast('Refreshed — ' + inventoryGroups.length + ' groups', 'success');
        } catch (e) { showToast('Refresh failed: ' + e.message, 'error'); }
    }

    function startAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(backgroundSync, REFRESH_INTERVAL);
    }

    /* ══════════════════════════════════════════════════════════
       GROUPING
       ══════════════════════════════════════════════════════════ */
    const ALLOWED_LOCATIONS = ['Ready Room', 'Processing', 'Receiving', 'Damaged', 'Locked', 'Inbound'];

    function groupInventory(items) {
        const map = new Map();
        items.forEach(item => {
            const location = item.location || '';
            if (!ALLOWED_LOCATIONS.includes(location)) return;
            const model = item.MODEL || 'Unknown Model';
            const storage = item.STORAGE || 'N/A';
            const grade = item.GRADE || '';
            const color = item.COLOR || '';
            // All grades included
            const key = `${model}|${storage}`;
            if (!map.has(key)) {
                const bd = detectBrand(model);
                const locs = {};
                ALLOWED_LOCATIONS.forEach(l => locs[l] = 0);
                map.set(key, {
                    key, model, storage,
                    grades: { A: 0, B: 0, 'C (AMZ)': 0, C: 0, D: 0, Damaged: 0, Defective: 0, RAW: 0 },
                    colors: {},
                    colorsByGrade: { A: {}, B: {}, 'C (AMZ)': {}, C: {}, D: {}, Damaged: {}, Defective: {}, RAW: {} },
                    price: 0, lastPriceUpdate: null, total: 0,
                    brand: bd.brand, brandType: bd.type,
                    locations: locs,
                    totalCost: 0, costCount: 0
                });
            }
            const g = map.get(key);
            if (g.grades.hasOwnProperty(grade)) g.grades[grade]++;
            else g.grades['C']++;
            if (color) {
                g.colors[color] = (g.colors[color] || 0) + 1;
                const gradeKey = g.grades.hasOwnProperty(grade) ? grade : 'C';
                if (!g.colorsByGrade[gradeKey]) g.colorsByGrade[gradeKey] = {};
                g.colorsByGrade[gradeKey][color] = (g.colorsByGrade[gradeKey][color] || 0) + 1;
            }
            const itemCost = item.cost || (item.total_price_paid ? item.total_price_paid / 100 : 0);
            if (itemCost > 0) { g.totalCost += itemCost; g.costCount++; }
            g.total++;
            if (g.locations.hasOwnProperty(location)) g.locations[location]++;
        });
        return Array.from(map.values()).filter(g => g.total > 0);
    }

    /* ══════════════════════════════════════════════════════════
       PRICE MERGING
       ══════════════════════════════════════════════════════════ */
    async function mergeWithPrices() {
        const all = await pricingDB.getAllPrices();
        const pm = new Map();
        all.forEach(p => pm.set(`${p.model}_${p.storage}`, p));
        inventoryGroups.forEach(g => {
            const stored = pm.get(`${g.model}_${g.storage}`);
            if (stored && stored.gradeA > 0) {
                g.price = stored.gradeA;
                g.lastPriceUpdate = stored.lastUpdated;
            }
        });
    }

    /* ══════════════════════════════════════════════════════════
       STATUS
       ══════════════════════════════════════════════════════════ */
    function getRowStatus(group) {
        if (group.price <= 0) return 'unpriced';
        if (group.lastPriceUpdate) {
            const days = (Date.now() - new Date(group.lastPriceUpdate).getTime()) / 864e5;
            if (days > STALE_DAYS) return 'stale';
        }
        return 'priced';
    }
    function getRowValue(group) { return group.total * group.price; }

    /* ══════════════════════════════════════════════════════════
       FILTER POPOVER
       ══════════════════════════════════════════════════════════ */
    function toggleFilterPopover() {
        const pop = document.getElementById('filterPopover');
        const bd = document.getElementById('filterBackdrop');
        const isOpen = pop.classList.contains('open');
        if (isOpen) { closeFilterPopover(); }
        else { pop.classList.add('open'); bd.classList.add('open'); }
    }
    function closeFilterPopover() {
        document.getElementById('filterPopover').classList.remove('open');
        document.getElementById('filterBackdrop').classList.remove('open');
    }

    function updateFilterButtonState() {
        const btn = document.getElementById('filterToggleBtn');
        const hasFilters = activeBrands.size > 0 || activeStorages.size > 0 || activeLocations.size > 0 ||
            document.getElementById('statusFilter').value !== 'all' ||
            document.getElementById('priceMin').value || document.getElementById('priceMax').value ||
            document.getElementById('qtyMin').value || document.getElementById('qtyMax').value;
        btn.classList.toggle('has-filters', hasFilters);
    }

    /* ══════════════════════════════════════════════════════════
       FILTER CHIPS — build from inventory data
       ══════════════════════════════════════════════════════════ */
    function buildFilterChips() {
        allBrands = {};
        allStorages = {};
        let allLocations = {};
        ALLOWED_LOCATIONS.forEach(l => allLocations[l] = 0);
        inventoryGroups.forEach(g => {
            allBrands[g.brand] = (allBrands[g.brand] || 0) + 1;
            allStorages[g.storage] = (allStorages[g.storage] || 0) + 1;
            if (g.locations) {
                ALLOWED_LOCATIONS.forEach(loc => {
                    if (g.locations[loc] > 0) allLocations[loc] = (allLocations[loc] || 0) + g.locations[loc];
                });
            }
        });

        const sortedBrands = Object.entries(allBrands).sort((a, b) => b[1] - a[1]);
        const brandContainer = document.getElementById('brandChips');
        brandContainer.innerHTML = sortedBrands.map(([brand, count]) =>
            `<div class="brand-chip ${activeBrands.has(brand) ? 'active' : ''}" onclick="toggleBrandFilter('${escJs(brand)}')">${escHtml(brand)} <span class="chip-count">${count}</span></div>`
        ).join('');

        const sizeOrder = s => {
            const n = parseInt(s);
            if (s.includes('TB')) return n * 1024;
            return n || 0;
        };
        const sortedStorages = Object.entries(allStorages).sort((a, b) => sizeOrder(a[0]) - sizeOrder(b[0]));
        const storageContainer = document.getElementById('storageChips');
        storageContainer.innerHTML = sortedStorages.map(([storage, count]) =>
            `<div class="storage-chip ${activeStorages.has(storage) ? 'active' : ''}" onclick="toggleStorageFilter('${escJs(storage)}')">${escHtml(storage)}</div>`
        ).join('');

        const locationContainer = document.getElementById('locationChips');
        locationContainer.innerHTML = Object.entries(allLocations).map(([loc, count]) =>
            `<div class="brand-chip ${activeLocations.has(loc) ? 'active' : ''}" onclick="toggleLocationFilter('${escJs(loc)}')">${escHtml(loc)} <span class="chip-count">${count}</span></div>`
        ).join('');
    }

    function toggleBrandFilter(brand) {
        if (activeBrands.has(brand)) activeBrands.delete(brand);
        else activeBrands.add(brand);
        buildFilterChips();
        onFilterChange();
    }

    function toggleStorageFilter(storage) {
        if (activeStorages.has(storage)) activeStorages.delete(storage);
        else activeStorages.add(storage);
        buildFilterChips();
        onFilterChange();
    }

    function toggleLocationFilter(loc) {
        if (activeLocations.has(loc)) activeLocations.delete(loc);
        else activeLocations.add(loc);
        buildFilterChips();
        onFilterChange();
    }

    /* Quick presets */
    function applyPreset() {
        const v = document.getElementById('presetFilter').value;
        if (!v) return;
        activeBrands.clear();
        activeStorages.clear();
        activeLocations.clear();
        document.getElementById('priceMin').value = '';
        document.getElementById('priceMax').value = '';
        document.getElementById('qtyMin').value = '';
        document.getElementById('qtyMax').value = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';

        if (v === 'iphones') {
            document.getElementById('searchInput').value = 'iphone';
        } else if (v === 'ipads') {
            document.getElementById('searchInput').value = 'ipad';
        } else if (v === 'samsung') {
            activeBrands.add('Samsung');
        } else if (v === 'highvalue') {
            document.getElementById('priceMin').value = '500';
        } else if (v === 'bulk') {
            document.getElementById('qtyMin').value = '10';
        } else if (v === 'unpriced') {
            document.getElementById('statusFilter').value = 'unpriced';
        }
        document.getElementById('presetFilter').value = '';
        buildFilterChips();
        onFilterChange();
    }

    /* ══════════════════════════════════════════════════════════
       FILTERING & SORTING
       ══════════════════════════════════════════════════════════ */
    function onFilterChange() { applyFiltersAndRender(); }
    function onSortChange() { applyFiltersAndRender(); }

    function applyFiltersAndRender() {
        const search = (document.getElementById('searchInput').value || '').toLowerCase().trim();
        const sf = document.getElementById('statusFilter').value;
        const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
        const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;
        const qtyMin = parseInt(document.getElementById('qtyMin').value) || 0;
        const qtyMax = parseInt(document.getElementById('qtyMax').value) || Infinity;

        filteredGroups = inventoryGroups.filter(g => {
            if (search && !g.model.toLowerCase().includes(search) && !g.storage.toLowerCase().includes(search)) return false;
            if (sf !== 'all') {
                const s = getRowStatus(g);
                if (sf === 'unpriced' && s !== 'unpriced') return false;
                if (sf === 'priced' && s !== 'priced') return false;
                if (sf === 'stale' && s !== 'stale') return false;
            }
            if (activeBrands.size > 0 && !activeBrands.has(g.brand)) return false;
            if (activeStorages.size > 0 && !activeStorages.has(g.storage)) return false;
            if (activeLocations.size > 0) {
                const hasMatchingLocation = [...activeLocations].some(loc => g.locations && g.locations[loc] > 0);
                if (!hasMatchingLocation) return false;
            }
            if (g.price > 0 && (g.price < priceMin || g.price > priceMax)) return false;
            if (priceMin > 0 && g.price <= 0) return false;
            if (g.total < qtyMin || g.total > qtyMax) return false;
            return true;
        });

        const sortVal = document.getElementById('sortSelect').value;
        const [field, dir] = sortVal.split('-');
        const m = dir === 'desc' ? -1 : 1;
        filteredGroups.sort((a, b) => {
            if (field === 'model') return m * a.model.localeCompare(b.model);
            if (field === 'total') return m * (a.total - b.total);
            if (field === 'value') return m * (getRowValue(a) - getRowValue(b));
            if (field === 'status') { const o = { unpriced: 0, stale: 1, priced: 2 }; return (o[getRowStatus(a)]??2) - (o[getRowStatus(b)]??2); }
            return 0;
        });

        renderTable();
        updateFooter();
        updateActiveFilterTags();
        updateFilterButtonState();
        document.getElementById('filteredCount').textContent = `${filteredGroups.length} of ${inventoryGroups.length}`;
        document.getElementById('emptyState').style.display = filteredGroups.length === 0 ? 'block' : 'none';
    }

    function updateActiveFilterTags() {
        const container = document.getElementById('activeFilters');
        const strip = document.getElementById('activeFiltersStrip');
        const tags = [];
        activeBrands.forEach(b => tags.push({ label: b, type: 'brand', value: b }));
        activeStorages.forEach(s => tags.push({ label: s, type: 'storage', value: s }));
        activeLocations.forEach(l => tags.push({ label: l, type: 'location', value: l }));
        const pMin = document.getElementById('priceMin').value;
        const pMax = document.getElementById('priceMax').value;
        if (pMin || pMax) tags.push({ label: `$${pMin || '0'} – $${pMax || '∞'}`, type: 'price' });
        const qMin = document.getElementById('qtyMin').value;
        const qMax = document.getElementById('qtyMax').value;
        if (qMin || qMax) tags.push({ label: `Qty ${qMin || '0'} – ${qMax || '∞'}`, type: 'qty' });
        const search = document.getElementById('searchInput').value.trim();
        if (search) tags.push({ label: `"${search}"`, type: 'search' });
        const sf = document.getElementById('statusFilter').value;
        if (sf !== 'all') tags.push({ label: sf.charAt(0).toUpperCase() + sf.slice(1), type: 'status' });

        if (tags.length === 0) {
            container.innerHTML = '';
            strip.classList.remove('has-filters');
            return;
        }
        strip.classList.add('has-filters');
        container.innerHTML = tags.map(t =>
            `<span class="filter-tag">${escHtml(t.label)} <span class="remove-tag" onclick="removeFilter('${t.type}','${escJs(t.value || '')}')">&times;</span></span>`
        ).join('') + `<button class="clear-all-btn" onclick="clearAllFilters()">Clear all</button>`;
    }

    function removeFilter(type, value) {
        if (type === 'brand') { activeBrands.delete(value); buildFilterChips(); }
        else if (type === 'storage') { activeStorages.delete(value); buildFilterChips(); }
        else if (type === 'location') { activeLocations.delete(value); buildFilterChips(); }
        else if (type === 'price') { document.getElementById('priceMin').value = ''; document.getElementById('priceMax').value = ''; }
        else if (type === 'qty') { document.getElementById('qtyMin').value = ''; document.getElementById('qtyMax').value = ''; }
        else if (type === 'search') { document.getElementById('searchInput').value = ''; }
        else if (type === 'status') { document.getElementById('statusFilter').value = 'all'; }
        onFilterChange();
    }

    function clearAllFilters() {
        activeBrands.clear();
        activeStorages.clear();
        activeLocations.clear();
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('priceMin').value = '';
        document.getElementById('priceMax').value = '';
        document.getElementById('qtyMin').value = '';
        document.getElementById('qtyMax').value = '';
        buildFilterChips();
        onFilterChange();
    }

    /* ══════════════════════════════════════════════════════════
       RENDERING — clean table rows
       ══════════════════════════════════════════════════════════ */
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = filteredGroups.map((g, idx) => {
            const key = g.key, status = getRowStatus(g), value = getRowValue(g), sel = selectedRows.has(key);
            const bc = brandClass(g.brand);
            const inDeal = dealItems.has(key);

            // Compact grade display
            const grades = ['A', 'B', 'C (AMZ)', 'C', 'D', 'Damaged', 'Defective', 'RAW'].map(grade => {
                const qty = g.grades[grade] || 0;
                const label = grade === 'C (AMZ)' ? 'AMZ' : grade === 'Damaged' ? 'DMG' : grade === 'Defective' ? 'DEF' : grade;
                return `<span class="grade-item ${qty === 0 ? 'empty' : ''}"><span class="g-label">${label}</span> ${qty}</span>`;
            }).join('');

            return `
            <tr class="${sel ? 'selected' : ''} ${bc}" data-key="${escHtml(key)}">
                <td><input type="checkbox" class="row-checkbox" ${sel ? 'checked' : ''} onchange="toggleRow('${escJs(key)}')"></td>
                <td>
                    <div class="cell-model" title="${escHtml(g.model)}">${escHtml(g.model)}</div>
                    <div class="cell-model-sub">${escHtml(g.brand)}</div>
                </td>
                <td class="cell-storage">${escHtml(g.storage)}</td>
                <td><div class="grade-display">${grades}</div></td>
                <td class="cell-total">${g.total}</td>
                <td class="price-cell">
                    <div class="grade-price-input">
                        <span>$</span>
                        <input type="number" min="0" step="1" value="${g.price > 0 ? g.price : ''}"
                            data-key="${escHtml(key)}" onfocus="this.select()"
                            onblur="handlePriceBlur(this)" onkeydown="handlePriceKey(event, this)" placeholder="—">
                    </div>
                </td>
                <td style="text-align:center;font-family:var(--font-mono);font-size:12px;color:var(--text-secondary);">${g.costCount > 0 ? '$' + Math.round(g.totalCost / g.costCount).toLocaleString() : '—'}</td>
                <td class="cell-value ${value === 0 ? 'no-value' : ''}">${value > 0 ? '$' + value.toLocaleString() : '—'}</td>
                <td style="text-align:center"><span class="status-dot ${status}" title="${status}"></span></td>
                <td style="text-align:center"><button class="add-deal-btn ${inDeal ? 'in-deal' : ''}" onclick="toggleDealItem('${escJs(key)}')" title="${inDeal ? 'Remove from deal' : 'Add to deal'}">${inDeal ? '✓' : '+'}</button></td>
                <td style="text-align:center"><button class="hist-btn" onclick="showPriceHistory('${escJs(g.model)}','${escJs(g.storage)}')" title="Price history">📊</button></td>
            </tr>`;
        }).join('');
    }

    /* ══════════════════════════════════════════════════════════
       FOOTER
       ══════════════════════════════════════════════════════════ */
    function updateFooter() {
        let units = 0, val = 0;
        filteredGroups.forEach(g => {
            // If location filter is active, count only units in those locations
            if (activeLocations.size > 0) {
                let locUnits = 0;
                activeLocations.forEach(loc => { locUnits += (g.locations && g.locations[loc]) ? g.locations[loc] : 0; });
                units += locUnits;
            } else {
                units += g.total;
            }
            val += getRowValue(g);
        });
        document.getElementById('footerShowing').textContent = filteredGroups.length.toLocaleString();
        document.getElementById('footerUnits').textContent = units.toLocaleString();
        document.getElementById('footerValue').textContent = '$' + val.toLocaleString();
        document.getElementById('footerSelected').textContent = selectedRows.size.toLocaleString();
    }

    /* ══════════════════════════════════════════════════════════
       INLINE PRICE EDITING
       ══════════════════════════════════════════════════════════ */
    function handlePriceKey(event, input) {
        if (event.key === 'Enter') {
            event.preventDefault(); savePrice(input);
            const next = input.closest('tr').nextElementSibling;
            if (next) { const ni = next.querySelector('.grade-price-input input'); if (ni) { ni.focus(); return; } }
            input.blur();
        } else if (event.key === 'Tab') { savePrice(input); }
        else if (event.key === 'Escape') { input.blur(); }
    }
    function handlePriceBlur(input) { savePrice(input); }

    async function savePrice(input) {
        const key = input.dataset.key;
        const newVal = parseFloat(input.value) || 0;
        const group = inventoryGroups.find(g => g.key === key);
        if (!group || newVal === group.price) return;
        group.price = newVal;
        try {
            const p = newVal;
            await pricingDB.saveModelPrice({
                model: group.model, storage: group.storage,
                gradeA: p, gradeB: p, gradeC: p, gradeCAMZ: p, gradeD: 0, defective: 0
            });
            // Persist to server DB for history
            fetch('/api/prices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: group.model, storage: group.storage, price: p })
            }).catch(e => console.warn('Server price sync failed:', e));
            group.lastPriceUpdate = new Date().toISOString();
            input.classList.add('just-saved');
            setTimeout(() => input.classList.remove('just-saved'), 600);
            const row = input.closest('tr');
            if (row) {
                const vc = row.querySelector('.cell-value');
                const val = getRowValue(group);
                if (vc) { vc.textContent = val > 0 ? '$' + val.toLocaleString() : '—'; vc.className = 'cell-value ' + (val === 0 ? 'no-value' : ''); }
                const sd = row.querySelector('.status-dot');
                if (sd) { const s = getRowStatus(group); sd.className = 'status-dot ' + s; sd.title = s; }
            }
            if (dealItems.has(key)) {
                const di = dealItems.get(key);
                di.offerPrice = newVal;
                renderDealItems();
                saveDealState();
            }
            updateStats();
            updateFooter();
        } catch (e) { console.error('Save failed:', e); showToast('Failed to save', 'error'); }
    }

    /* ══════════════════════════════════════════════════════════
       ROW SELECTION
       ══════════════════════════════════════════════════════════ */
    function toggleRow(key) {
        selectedRows.has(key) ? selectedRows.delete(key) : selectedRows.add(key);
        const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
        if (row) row.classList.toggle('selected', selectedRows.has(key));
        updateSelectAllCheckbox();
        updateFooter();
    }
    function toggleSelectAll() {
        const c = document.getElementById('selectAll').checked;
        if (c) filteredGroups.forEach(g => selectedRows.add(g.key)); else selectedRows.clear();
        renderTable();
        updateFooter();
    }
    function updateSelectAllCheckbox() {
        const cb = document.getElementById('selectAll');
        cb.checked = filteredGroups.length > 0 && filteredGroups.every(g => selectedRows.has(g.key));
    }

    /* ══════════════════════════════════════════════════════════
       STATS
       ══════════════════════════════════════════════════════════ */
    function updateStats() {
        const total = inventoryGroups.length;
        const units = inventoryGroups.reduce((s, g) => s + g.total, 0);
        let priced = 0, unpriced = 0, totalVal = 0;
        inventoryGroups.forEach(g => { const s = getRowStatus(g); if (s === 'priced' || s === 'stale') priced++; else unpriced++; totalVal += getRowValue(g); });
        document.getElementById('statModels').textContent = total.toLocaleString();
        document.getElementById('statUnits').textContent = units.toLocaleString();
        const pct = total > 0 ? Math.round((priced / total) * 100) : 0;
        document.getElementById('statPriced').textContent = pct + '%';
        document.getElementById('statPriced').className = 'stat-value ' + (pct > 80 ? 'positive' : pct > 40 ? 'warning' : 'negative');
        document.getElementById('statUnpriced').textContent = unpriced.toLocaleString();
        document.getElementById('statUnpriced').className = 'stat-value ' + (unpriced === 0 ? 'positive' : 'negative');
        document.getElementById('statValue').textContent = '$' + totalVal.toLocaleString();
        document.getElementById('itemCountBadge').textContent = units > 0 ? `${units.toLocaleString()} units` : '';
    }

    /* ══════════════════════════════════════════════════════════
       SYNC INFO
       ══════════════════════════════════════════════════════════ */
    function updateSyncInfo() {
        const dot = document.getElementById('syncDot'), text = document.getElementById('syncText');
        if (!lastSyncTime) { dot.className = 'sync-dot error'; text.textContent = 'Not synced'; return; }
        dot.className = 'sync-dot'; text.textContent = 'Synced ' + timeAgo(lastSyncTime);
        clearTimeout(updateSyncInfo._t); updateSyncInfo._t = setTimeout(updateSyncInfo, 60000);
    }
    function timeAgo(d) { const s = Math.floor((Date.now() - d.getTime()) / 1000); if (s < 60) return 'just now'; const m = Math.floor(s / 60); if (m < 60) return m + 'm ago'; return Math.floor(m / 60) + 'h ago'; }

    /* ══════════════════════════════════════════════════════════
       DEAL BUILDER
       ══════════════════════════════════════════════════════════ */
    function setDealPanelState(open) {
        dealPanelOpen = open;
        document.getElementById('dealPanel').classList.toggle('open', open);
        document.getElementById('stickyFooter').classList.toggle('panel-open', open);
        document.body.classList.toggle('deal-open', open);
    }
    function openDealPanel() { setDealPanelState(true); }
    function closeDealPanel() { setDealPanelState(false); }
    function toggleDealPanel() {
        const isOpen = document.getElementById('dealPanel').classList.contains('open');
        setDealPanelState(!isOpen);
    }

    function toggleDealItem(key) {
        // Always open the form to add another grade/color — even if model already in deal
        // (User can remove individual entries from the deal panel itself)

        // If there's an uncommitted selection in the form, warn user
        if (dealSearchSelected) {
            const proceed = confirm(`You have "${dealSearchSelected.model}" selected but not added.\n\nDiscard it and select a new model?`);
            if (!proceed) return;
            // Clear current selection
            dealSearchSelected = null;
            dealSelectedGrade = '';
            dealSelectedColor = '';
            document.getElementById('dealAddRow').style.display = 'none';
            document.getElementById('dealAddPreview').textContent = '';
            document.getElementById('dealAddBtn').disabled = true;
        }

        // Open deal panel and populate the selection form (don't auto-add)
        const group = inventoryGroups.find(g => g.key === key);
        if (!group) return;
        if (!dealPanelOpen) openDealPanel();
        selectDealModel(key, true);
    }

    function updateRowDealButton(baseKey) {
        const row = document.querySelector(`tr[data-key="${CSS.escape(baseKey)}"]`);
        if (!row) return;
        const btn = row.querySelector('.add-deal-btn');
        if (!btn) return;
        const inDeal = Array.from(dealItems.keys()).some(k => k.startsWith(baseKey + '|') || k === baseKey);
        btn.className = 'add-deal-btn ' + (inDeal ? 'in-deal' : '');
        btn.textContent = inDeal ? '✓' : '+';
        btn.title = inDeal ? 'Remove from deal' : 'Add to deal';
    }

    function renderDealItems() {
        const list = document.getElementById('dealItemsList');
        const summary = document.getElementById('dealSummary');
        const actions = document.getElementById('dealActions');
        const header = document.getElementById('dealItemsHeader');

        if (dealItems.size === 0) {
            list.innerHTML = '';
            list.appendChild(document.getElementById('dealEmpty'));
            document.getElementById('dealEmpty').style.display = 'flex';
            summary.style.display = 'none';
            actions.style.display = 'none';
            header.textContent = 'Items (0)';
            return;
        }

        header.textContent = `Items (${dealItems.size})`;
        let totalUnits = 0, totalValue = 0;

        list.innerHTML = Array.from(dealItems.values()).map(item => {
            const subtotal = item.offerQty * item.offerPrice;
            totalUnits += item.offerQty;
            totalValue += subtotal;
            const gradeLabel = item.grade ? ` [${item.grade}]` : '';
            return `
            <div class="deal-item" data-deal-key="${escHtml(item.key)}">
                <div class="deal-item-top">
                    <div class="deal-item-name" title="${escHtml(item.model)}">${escHtml(item.model)}${gradeLabel}</div>
                    <button class="deal-item-remove" onclick="toggleDealItem('${escJs(item.key)}')">&times;</button>
                </div>
                <div class="deal-item-details">
                    <span class="avail">${escHtml(item.storage)}${item.grade ? ' · Grade ' + escHtml(item.grade) : ''}${item.color ? ' · ' + escHtml(item.color) : ''} &middot; Avail: ${item.maxQty}</span>
                    <span>Qty:</span>
                    <input type="number" min="1" max="${item.maxQty}" value="${item.offerQty}"
                        onchange="updateDealQty('${escJs(item.key)}', this.value)"
                        onfocus="this.select()">
                    <span>@ $</span>
                    <input type="number" min="0" step="1" value="${item.offerPrice || ''}" placeholder="0"
                        onchange="updateDealPrice('${escJs(item.key)}', this.value)"
                        onfocus="this.select()">
                    <span class="deal-item-subtotal">${subtotal > 0 ? '$' + subtotal.toLocaleString() : '—'}</span>
                </div>
            </div>`;
        }).join('');

        document.getElementById('dealSumModels').textContent = dealItems.size;
        document.getElementById('dealSumUnits').textContent = totalUnits.toLocaleString();
        document.getElementById('dealSumValue').textContent = '$' + totalValue.toLocaleString();
        summary.style.display = 'block';
        actions.style.display = 'flex';
    }

    function updateDealQty(key, val) {
        const item = dealItems.get(key);
        if (!item) return;
        item.offerQty = Math.max(1, Math.min(item.maxQty, parseInt(val) || 1));
        renderDealItems();
        saveDealState();
    }

    function updateDealPrice(key, val) {
        const item = dealItems.get(key);
        if (!item) return;
        item.offerPrice = Math.max(0, parseFloat(val) || 0);
        renderDealItems();
        saveDealState();
    }

    function updateDealBadge() {
        const badge = document.getElementById('dealBadge');
        if (dealItems.size > 0) {
            badge.textContent = dealItems.size;
            badge.classList.add('visible');
        } else {
            badge.classList.remove('visible');
        }
    }

    function clearDeal() {
        const keys = Array.from(dealItems.keys());
        dealItems.clear();
        renderDealItems();
        updateDealBadge();
        saveDealState();
        keys.forEach(key => {
            const row = document.querySelector(`tr[data-key="${CSS.escape(key)}"]`);
            if (row) {
                const btn = row.querySelector('.add-deal-btn');
                if (btn) { btn.className = 'add-deal-btn'; btn.textContent = '+'; btn.title = 'Add to deal'; }
            }
        });
        document.getElementById('dealName').value = '';
        document.getElementById('dealBuyer').value = '';
        sessionStorage.removeItem('pricing_deal_state');
        showToast('Deal cleared', 'success');
    }

    /* ══════════════════════════════════════════════════════════
       DEAL MAKER — SEARCH + ADD
       ══════════════════════════════════════════════════════════ */
    let dealSearchSelected = null;

    let dealSelectedGrade = '';
    let dealSelectedColor = '';

    function onDealSearch() {
        const q = document.getElementById('dealModelSearch').value.trim().toLowerCase();
        const dd = document.getElementById('dealSearchDropdown');
        let results = inventoryGroups;
        if (q.length > 0) {
            results = inventoryGroups.filter(g => g.model.toLowerCase().includes(q) || g.storage.toLowerCase().includes(q));
        }
        results = results.slice(0, 30);
        if (results.length === 0) {
            dd.innerHTML = '<div style="padding:10px;color:var(--text-secondary);font-size:12px;">No results</div>';
        } else {
            dd.innerHTML = results.map(g => {
                const colorList = Object.keys(g.colors || {}).slice(0, 4).join(', ');
                const moreColors = Object.keys(g.colors || {}).length > 4 ? ` +${Object.keys(g.colors).length - 4}` : '';
                return `
                <div class="deal-search-opt" onclick="selectDealModel('${escJs(g.key)}')">
                    <div><div class="ds-name">${escHtml(g.model)}</div><div class="ds-meta">${escHtml(g.storage)} · A:${g.grades.A} B:${g.grades.B} C:${g.grades.C} AMZ:${g.grades['C (AMZ)']} D:${g.grades.D||0} DMG:${g.grades.Damaged||0} DEF:${g.grades.Defective||0} RAW:${g.grades.RAW||0}</div>${colorList ? `<div class="ds-colors">${escHtml(colorList)}${moreColors}</div>` : ''}</div>
                    <div class="ds-stock">${g.total}</div>
                </div>`;
            }).join('');
        }
        dd.classList.add('visible');
    }

    function selectDealModel(key, skipGuard) {
        // Guard: if there's already an uncommitted selection from search dropdown
        if (!skipGuard && dealSearchSelected && dealSearchSelected.key !== key) {
            const proceed = confirm(`You have "${dealSearchSelected.model}" selected but not added.\n\nDiscard it and select a new model?`);
            if (!proceed) return;
        }
        dealSearchSelected = inventoryGroups.find(g => g.key === key);
        if (!dealSearchSelected) return;
        document.getElementById('dealSearchDropdown').classList.remove('visible');
        document.getElementById('dealModelSearch').value = '';
        document.getElementById('dealAddSelected').textContent = `${dealSearchSelected.model} — ${dealSearchSelected.storage}`;
        const gr = dealSearchSelected.grades;
        document.getElementById('dealAddStock').textContent = `Stock: A:${gr.A}  B:${gr.B}  C:${gr.C}  AMZ:${gr['C (AMZ)']}  D:${gr.D||0}  DMG:${gr.Damaged||0}  DEF:${gr.Defective||0}  RAW:${gr.RAW||0}`;
        document.getElementById('dealAddRow').style.display = 'block';
        document.getElementById('dealPriceInput').value = dealSearchSelected.price > 0 ? dealSearchSelected.price : '';
        document.getElementById('dealQtyInput').value = '1';

        // Render grade chips — disable add until grade picked
        dealSelectedGrade = '';
        document.getElementById('dealAddBtn').disabled = true;
        document.getElementById('dealAddPreview').textContent = '';
        const gradeChips = document.getElementById('dealGradeChips');
        gradeChips.innerHTML = ['A', 'B', 'C', 'C (AMZ)', 'D', 'Damaged', 'Defective', 'RAW'].map(g => {
            const count = gr[g] || 0;
            const disabled = count === 0;
            return `<div class="deal-chip${disabled ? ' disabled' : ''}" data-grade="${escHtml(g)}" onclick="pickDealGrade(this,'${escJs(g)}')">${escHtml(g)}<span class="dc-count">(${count})</span></div>`;
        }).join('');

        // Auto-select first available grade
        const firstGrade = ['A', 'B', 'C', 'C (AMZ)', 'D', 'Damaged', 'Defective', 'RAW'].find(g => gr[g] > 0);
        if (firstGrade) {
            const el = gradeChips.querySelector(`[data-grade="${firstGrade}"]`);
            if (el) pickDealGrade(el, firstGrade);
        }

        // Render color chips (initially all colors, will filter when grade is picked)
        dealSelectedColor = '';
        renderDealColorChips(dealSearchSelected, dealSelectedGrade);

        // Sync hidden grade select
        const gradeSelect = document.getElementById('dealGradeSelect');
        gradeSelect.innerHTML = '';
        ['A', 'B', 'C', 'C (AMZ)', 'D', 'Damaged', 'Defective', 'RAW'].forEach(g => {
            if (gr[g] > 0) { const opt = document.createElement('option'); opt.value = g; opt.textContent = g; gradeSelect.appendChild(opt); }
        });
    }

    function pickDealGrade(el, grade) {
        document.querySelectorAll('#dealGradeChips .deal-chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        dealSelectedGrade = grade;
        document.getElementById('dealGradeSelect').value = grade;
        document.getElementById('dealAddBtn').disabled = false;
        updateDealPreview();
        // Re-render color chips filtered by this grade
        if (dealSearchSelected) {
            renderDealColorChips(dealSearchSelected, grade);
        }
    }

    function renderDealColorChips(group, grade) {
        dealSelectedColor = '';
        const colorChips = document.getElementById('dealColorChips');
        // Use grade-filtered colors if a grade is selected, otherwise all colors
        const colors = (grade && group.colorsByGrade && group.colorsByGrade[grade])
            ? group.colorsByGrade[grade]
            : (group.colors || {});
        const gradeTotal = grade ? (group.grades[grade] || 0) : group.total;
        const colorKeys = Object.keys(colors).sort();
        if (colorKeys.length === 0) {
            colorChips.innerHTML = '<span style="font-size:11px;color:var(--text-muted);">No color data</span>';
        } else {
            colorChips.innerHTML = `<div class="deal-chip selected" data-color="" onclick="pickDealColor(this,'')">Any<span class="dc-count">(${gradeTotal})</span></div>` +
                colorKeys.map(c => `<div class="deal-chip" data-color="${escHtml(c)}" onclick="pickDealColor(this,'${escJs(c)}')">${escHtml(c)}<span class="dc-count">(${colors[c]})</span></div>`).join('');
        }
        // Update hidden select
        const colorSelect = document.getElementById('dealColorSelect');
        colorSelect.innerHTML = '<option value="">Any</option>';
        colorKeys.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; colorSelect.appendChild(opt); });
        // Update stock hint
        document.getElementById('dealAddStock').textContent = grade
            ? `Stock for Grade ${grade}: ${gradeTotal} units`
            : `Stock: A:${group.grades.A}  B:${group.grades.B}  C:${group.grades.C}  AMZ:${group.grades['C (AMZ)']}  D:${group.grades.D||0}  DMG:${group.grades.Damaged||0}  DEF:${group.grades.Defective||0}  RAW:${group.grades.RAW||0}`;
    }

    function pickDealColor(el, color) {
        document.querySelectorAll('#dealColorChips .deal-chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        dealSelectedColor = color;
        document.getElementById('dealColorSelect').value = color;
    }

    function updateDealPreview() {
        const el = document.getElementById('dealAddPreview');
        if (!dealSearchSelected || !dealSelectedGrade) { el.textContent = ''; return; }
        const qty = parseInt(document.getElementById('dealQtyInput').value) || 0;
        const price = parseFloat(document.getElementById('dealPriceInput').value) || 0;
        const total = qty * price;
        el.innerHTML = total > 0 ? `${qty} × $${price} = <span class="preview-total">$${total.toLocaleString()}</span>` : '';
    }

    function addDealSearchItem() {
        if (!dealSearchSelected) return;
        const grade = dealSelectedGrade || document.getElementById('dealGradeSelect').value;
        const color = dealSelectedColor || '';
        const qty = parseInt(document.getElementById('dealQtyInput').value) || 1;
        const price = parseFloat(document.getElementById('dealPriceInput').value) || dealSearchSelected.price || 0;
        const key = dealSearchSelected.key;

        // Add to dealItems map with grade+color suffix to allow same model different grades/colors
        const dealKey = `${key}|${grade}|${color}`;
        if (dealItems.has(dealKey)) {
            // Update existing
            const existing = dealItems.get(dealKey);
            existing.offerQty += qty;
            existing.offerPrice = price;
        } else {
            dealItems.set(dealKey, {
                key: dealKey,
                model: dealSearchSelected.model,
                storage: dealSearchSelected.storage,
                brand: dealSearchSelected.brand,
                grade: grade,
                color: color,
                maxQty: dealSearchSelected.grades[grade] || dealSearchSelected.total,
                offerQty: Math.max(1, qty),
                offerPrice: price,
                grades: { ...dealSearchSelected.grades }
            });
            if (!dealPanelOpen) openDealPanel();
        }

        // Update table row button
        const baseKey = key;
        updateRowDealButton(baseKey);

        // Reset and refocus for rapid multi-add
        dealSearchSelected = null;
        dealSelectedGrade = '';
        dealSelectedColor = '';
        document.getElementById('dealAddRow').style.display = 'none';
        document.getElementById('dealAddPreview').textContent = '';
        document.getElementById('dealAddBtn').disabled = true;
        renderDealItems();
        updateDealBadge();
        saveDealState();
        showToast('Added to deal', 'success');
        // Refocus search for next item
        const searchInput = document.getElementById('dealModelSearch');
        searchInput.value = '';
        searchInput.focus();
    }

    // Close deal search dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.deal-search-wrap')) {
            document.getElementById('dealSearchDropdown').classList.remove('visible');
        }
    });

    /* ══════════════════════════════════════════════════════════
       DEAL PERSISTENCE (sessionStorage)
       ══════════════════════════════════════════════════════════ */
    function saveDealState() {
        try {
            const data = {
                items: Array.from(dealItems.entries()),
                name: document.getElementById('dealName').value,
                buyer: document.getElementById('dealBuyer').value
            };
            sessionStorage.setItem('pricing_deal_state', JSON.stringify(data));
        } catch (e) { console.warn('Deal save failed:', e); }
    }

    function loadDealState() {
        try {
            const raw = sessionStorage.getItem('pricing_deal_state');
            if (!raw) return;
            const data = JSON.parse(raw);
            if (data.items) {
                dealItems = new Map(data.items);
            }
            if (data.name) document.getElementById('dealName').value = data.name;
            if (data.buyer) document.getElementById('dealBuyer').value = data.buyer;
            updateDealBadge();
            renderDealItems();
        } catch (e) { console.warn('Deal load failed:', e); }
    }

    /* ══════════════════════════════════════════════════════════
       DEAL EXPORT
       ══════════════════════════════════════════════════════════ */
    function openProceedModal() {
        try {
            if (dealItems.size === 0) { showToast('No items in deal', 'error'); return; }
            let totalUnits = 0, totalValue = 0;
            dealItems.forEach(item => { totalUnits += item.offerQty; totalValue += item.offerQty * (item.offerPrice || 0); });
            document.getElementById('proceedItems').textContent = dealItems.size;
            document.getElementById('proceedUnits').textContent = totalUnits.toLocaleString();
            document.getElementById('proceedValue').textContent = '$' + totalValue.toLocaleString();
            const modal = document.getElementById('proceedModal');
            modal.style.cssText = 'display:flex !important; z-index:10000 !important; position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(4px); align-items:center; justify-content:center; padding:24px;';
            modal.classList.add('visible');
            setTimeout(() => { const dn = document.getElementById('dealName'); if (dn) dn.focus(); }, 100);
        } catch (e) {
            console.error('openProceedModal error:', e);
            alert('Error opening deal modal: ' + e.message);
        }
    }
    function closeProceedModal() {
        const modal = document.getElementById('proceedModal');
        modal.style.cssText = 'display:none;';
        modal.classList.remove('visible');
    }
    function saveDealFromModal() {
        saveDealOnly();
        closeProceedModal();
    }
    function exportDealFromModal() {
        exportDeal();
        closeProceedModal();
    }

    // Attach proceed button listener
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('proceedBtn');
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                console.log('Proceed clicked, dealItems size:', dealItems.size);
                openProceedModal();
            });
        }
    });
    // Also attach immediately in case DOMContentLoaded already fired
    setTimeout(() => {
        const btn = document.getElementById('proceedBtn');
        if (btn && !btn._listenerAttached) {
            btn._listenerAttached = true;
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                openProceedModal();
            });
        }
    }, 1000);

    function exportDeal() {
        if (dealItems.size === 0) { showToast('No items in deal', 'error'); return; }

        const dealName = document.getElementById('dealName').value.trim() || 'Untitled Deal';
        const buyer = document.getElementById('dealBuyer').value.trim();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        // Build worksheet data
        const wsData = [];
        wsData.push(['UNIVERSAL CELLULAR — Deal Sheet']);
        wsData.push(['Deal', dealName]);
        wsData.push(['Date', dateStr]);
        if (buyer) wsData.push(['Buyer', buyer]);
        wsData.push([]);
        wsData.push(['#', 'MODEL', 'STORAGE', 'GRADE', 'COLOR', 'QTY', 'PRICE', 'SUBTOTAL']);

        let totalUnits = 0, totalValue = 0, idx = 0;
        dealItems.forEach(item => {
            idx++;
            const sub = item.offerQty * item.offerPrice;
            totalUnits += item.offerQty;
            totalValue += sub;
            wsData.push([idx, item.model, item.storage, item.grade || 'All', item.color || '', item.offerQty, item.offerPrice > 0 ? item.offerPrice : '', sub > 0 ? sub : '']);
        });

        wsData.push([]);
        wsData.push(['', '', '', '', 'TOTAL', totalUnits, '', totalValue]);

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!cols'] = [
            { wch: 4 }, { wch: 32 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 8 }, { wch: 10 }, { wch: 12 }
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Deal');

        const safeName = dealName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
        const fileName = `Deal_${safeName}${buyer ? '_' + buyer.replace(/\s+/g, '_') : ''}_${now.toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast(`Exported ${dealItems.size} items as Excel`, 'success');

        // Save to server
        saveDealToServer(dealName, buyer, totalUnits, totalValue);
    }

    function saveDealOnly() {
        if (dealItems.size === 0) { showToast('No items in deal', 'error'); return; }
        const dealName = document.getElementById('dealName').value.trim() || 'Untitled Deal';
        const buyer = document.getElementById('dealBuyer').value.trim();
        let totalUnits = 0, totalValue = 0;
        dealItems.forEach(item => { totalUnits += item.offerQty; totalValue += item.offerQty * item.offerPrice; });
        saveDealToServer(dealName, buyer, totalUnits, totalValue);
    }

    function saveDealToServer(dealName, buyer, totalUnits, totalValue) {
        const items = Array.from(dealItems.values()).map(item => ({
            model: item.model || '',
            storage: item.storage || '',
            grade: item.grade || 'All',
            color: item.color || '',
            qty: item.offerQty || 0,
            price: item.offerPrice || 0,
            subtotal: (item.offerQty || 0) * (item.offerPrice || 0)
        }));
        fetch('/api/deals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ deal_name: dealName, buyer, items, total_units: totalUnits, total_value: totalValue })
        }).then(r => r.json()).then(data => {
            if (data.ok) {
                showToast('Deal saved to history', 'success');
                loadPastDeals();
            }
        }).catch(err => console.warn('Deal save failed:', err));
    }

    /* ══════════════════════════════════════════════════════════
       PAST DEALS
       ══════════════════════════════════════════════════════════ */
    let pastDealsOpen = false;

    function togglePastDeals() {
        pastDealsOpen = !pastDealsOpen;
        const list = document.getElementById('pastDealsList');
        list.style.display = pastDealsOpen ? 'flex' : 'none';
        if (pastDealsOpen) loadPastDeals();
    }

    function loadPastDeals() {
        const list = document.getElementById('pastDealsList');
        list.innerHTML = '<div class="past-deals-empty">Loading...</div>';
        fetch('/api/deals').then(r => r.json()).then(data => {
            const deals = data.deals || [];
            document.getElementById('pastDealsCount').textContent = deals.length > 0 ? deals.length : '';
            if (deals.length === 0) {
                list.innerHTML = '<div class="past-deals-empty">No past deals yet</div>';
                return;
            }
            list.innerHTML = deals.map(d => {
                const date = new Date(d.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const value = d.total_value > 0 ? `$${Number(d.total_value).toLocaleString()}` : '$0';
                return `<div class="past-deal-card" onclick="loadDeal(${d.id})">
                    <div class="pd-top"><span class="pd-name">${escHtml(d.deal_name)}</span><span class="pd-date">${date}</span></div>
                    <div class="pd-meta"><span>${d.total_units} units</span><span>${value}</span>${d.buyer ? `<span>${escHtml(d.buyer)}</span>` : ''}</div>
                    <div class="pd-actions" onclick="event.stopPropagation()">
                        <button class="pd-btn" onclick="loadDeal(${d.id})">Load</button>
                        <button class="pd-btn danger" onclick="deleteDeal(${d.id})">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }).catch(err => {
            list.innerHTML = '<div class="past-deals-empty">Failed to load deals</div>';
            console.warn('Load deals failed:', err);
        });
    }

    function loadDeal(id) {
        fetch(`/api/deals?id=${id}`).then(r => r.json()).then(data => {
            if (!data.deal) return showToast('Deal not found', 'error');
            const deal = data.deal;
            // Clear current deal
            dealItems.clear();
            // Load items
            const items = typeof deal.items === 'string' ? JSON.parse(deal.items) : deal.items;
            items.forEach(item => {
                const key = `${item.model}|${item.storage}|${item.grade || 'All'}`;
                dealItems.set(key, {
                    key,
                    model: item.model,
                    storage: item.storage,
                    grade: item.grade || 'All',
                    maxQty: item.qty,
                    offerQty: item.qty,
                    offerPrice: item.price || 0,
                    grades: {}
                });
            });
            document.getElementById('dealName').value = deal.deal_name || '';
            document.getElementById('dealBuyer').value = deal.buyer || '';
            renderDealItems();
            updateDealBadge();
            saveDealState();
            if (!dealPanelOpen) openDealPanel();
            showToast(`Loaded "${deal.deal_name}"`, 'success');
        }).catch(err => {
            showToast('Failed to load deal', 'error');
            console.warn(err);
        });
    }

    function deleteDeal(id) {
        if (!confirm('Delete this deal from history?')) return;
        fetch(`/api/deals?id=${id}`, { method: 'DELETE' }).then(r => r.json()).then(data => {
            if (data.ok) {
                showToast('Deal deleted', 'success');
                loadPastDeals();
                loadPastDealsModal();
            }
        }).catch(err => console.warn('Delete deal failed:', err));
    }

    /* ══════════════════════════════════════════════════════════
       PAST DEALS MODAL (top bar button)
       ══════════════════════════════════════════════════════════ */
    function openPastDealsModal() {
        const modal = document.getElementById('pastDealsModal');
        if (!modal) { alert('Past Deals modal not found'); return; }
        modal.classList.add('visible', 'active');
        modal.style.display = 'flex';
        const inner = modal.querySelector('.modal');
        if (inner) inner.classList.add('active');
        loadPastDealsModal();
    }
    function closePastDealsModal() {
        const modal = document.getElementById('pastDealsModal');
        modal.classList.remove('visible', 'active');
        modal.style.display = 'none';
        const inner = modal.querySelector('.modal');
        if (inner) inner.classList.remove('active');
    }
    function loadPastDealsModal() {
        const body = document.getElementById('pastDealsModalBody');
        body.innerHTML = '<div class="past-deals-empty">Loading...</div>';
        fetch('/api/deals').then(r => r.json()).then(data => {
            const deals = data.deals || [];
            if (deals.length === 0) {
                body.innerHTML = '<div class="past-deals-empty">No past deals yet</div>';
                return;
            }
            body.innerHTML = deals.map(d => {
                const date = new Date(d.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                const value = d.total_value > 0 ? '$' + Number(d.total_value).toLocaleString() : '$0';
                return `<div class="past-deal-card">
                    <div class="pd-top"><span class="pd-name">${escHtml(d.deal_name)}</span><span class="pd-date">${date}</span></div>
                    <div class="pd-meta"><span>${d.total_units} units</span><span>${value}</span>${d.buyer ? `<span>${escHtml(d.buyer)}</span>` : ''}</div>
                    <div class="pd-actions">
                        <button class="pd-btn" onclick="loadDeal(${d.id});closePastDealsModal()">Load</button>
                        <button class="pd-btn danger" onclick="deleteDeal(${d.id})">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }).catch(() => {
            body.innerHTML = '<div class="past-deals-empty">Failed to load deals</div>';
        });
    }

    /* ══════════════════════════════════════════════════════════
       EXCEL UPLOAD
       ══════════════════════════════════════════════════════════ */
    function openUploadModal() {
        pendingImport = null;
        document.getElementById('uploadResult').style.display = 'none';
        document.getElementById('uploadFooter').style.display = 'none';
        document.getElementById('fileInput').value = '';
        const um = document.getElementById('uploadModal');
        um.classList.add('visible', 'active');
        const umInner = um.querySelector('.modal');
        if (umInner) umInner.classList.add('active');
    }
    function closeUploadModal() { 
        const um = document.getElementById('uploadModal');
        um.classList.remove('visible', 'active');
        const umInner = um.querySelector('.modal');
        if (umInner) umInner.classList.remove('active');
    }

    function handleFileDrop(files) {
        if (!files || !files.length) return;
        const file = files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const priceMap = new Map();
                let sheetsFound = [];
                const targetSheets = wb.SheetNames.filter(n => /ready\s*breakdown|pro\s*breakdown/i.test(n));
                if (targetSheets.length === 0) targetSheets.push(wb.SheetNames[0]);
                targetSheets.forEach(sheetName => {
                    const ws = wb.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                    if (rows.length < 2) return;
                    const header = rows[0].map(h => String(h).trim().toUpperCase());
                    const modelCol = header.findIndex(h => h === 'MODEL' || h === 'PHONE/MODEL');
                    const storageCol = header.findIndex(h => h === 'STORAGE');
                    const priceCol = header.findIndex(h => h.includes('PRICE'));
                    if (modelCol === -1 || storageCol === -1) return;
                    if (priceCol === -1) return;
                    sheetsFound.push(sheetName);
                    for (let i = 1; i < rows.length; i++) {
                        const r = rows[i];
                        const model = String(r[modelCol] || '').trim();
                        const storage = String(r[storageCol] || '').trim();
                        const price = parseFloat(r[priceCol]) || 0;
                        if (model && storage && price > 0) {
                            priceMap.set(`${model}|${storage}`, price);
                        }
                    }
                });
                const resultDiv = document.getElementById('uploadResult');
                if (priceMap.size === 0) {
                    const hasPriceCol = targetSheets.some(sn => {
                        const ws = wb.Sheets[sn];
                        const h = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' })[0] || [];
                        return h.some(c => String(c).toUpperCase().includes('PRICE'));
                    });
                    resultDiv.innerHTML = hasPriceCol
                        ? `<div style="color:var(--warning);font-weight:600;">Found PRICE column but no valid prices. Make sure prices are numbers.</div>`
                        : `<div style="color:var(--negative);font-weight:600;">No PRICE column found.</div><p style="font-size:var(--text-sm);color:var(--text-secondary);margin-top:var(--space-2);">Add a column titled <strong>PRICE</strong> to your READY BREAKDOWN or PRO BREAKDOWN sheet and fill in the prices, then re-upload.</p>`;
                    resultDiv.style.display = 'block';
                    document.getElementById('uploadFooter').style.display = 'none';
                    return;
                }
                pendingImport = priceMap;
                resultDiv.innerHTML = `
                    <div style="font-weight:600;color:var(--positive);margin-bottom:var(--space-2);">Found ${priceMap.size} prices</div>
                    <div style="font-size:var(--text-sm);color:var(--text-secondary);">
                        Sheets: ${sheetsFound.join(', ')}<br>
                        File: ${file.name}
                    </div>`;
                resultDiv.style.display = 'block';
                document.getElementById('uploadFooter').style.display = 'flex';
            } catch (err) {
                console.error('Parse error:', err);
                document.getElementById('uploadResult').innerHTML = `<div style="color:var(--negative);">Failed to parse file: ${err.message}</div>`;
                document.getElementById('uploadResult').style.display = 'block';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function confirmImport() {
        if (!pendingImport || pendingImport.size === 0) return;
        const btn = document.getElementById('confirmImportBtn');
        btn.disabled = true; btn.textContent = 'Importing...';
        let imported = 0;
        for (const [key, price] of pendingImport) {
            const [model, storage] = key.split('|');
            try {
                await pricingDB.saveModelPrice({
                    model, storage,
                    gradeA: price, gradeB: price, gradeC: price, gradeCAMZ: price, gradeD: 0, defective: 0
                });
                const group = inventoryGroups.find(g => g.model === model && g.storage === storage);
                if (group) { group.price = price; group.lastPriceUpdate = new Date().toISOString(); }
                imported++;
            } catch (e) { console.warn('Import failed for', key, e); }
        }
        btn.disabled = false; btn.textContent = 'Import Prices';
        closeUploadModal();
        applyFiltersAndRender();
        updateStats();
        showToast(`Imported ${imported} prices`, 'success');
        pendingImport = null;
    }

    /* ══════════════════════════════════════════════════════════
       LEGACY EXPORT
       ══════════════════════════════════════════════════════════ */
    function exportCatalog() {
        const rows = filteredGroups.length > 0 ? filteredGroups : inventoryGroups;
        if (rows.length === 0) { showToast('No data to export', 'error'); return; }

        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const wsData = [];
        wsData.push(['UNIVERSAL CELLULAR — Full Catalog']);
        wsData.push(['Date', dateStr]);
        wsData.push(['Items', rows.length, 'Total Units', rows.reduce((s, g) => s + g.total, 0)]);
        wsData.push([]);
        wsData.push(['MODEL', 'STORAGE', 'BRAND', 'A', 'B', 'C (AMZ)', 'C', 'D', 'DAMAGED', 'DEFECTIVE', 'RAW', 'TOTAL', 'PRICE', 'AVG COST', 'VALUE',
            'Ready Room', 'Processing', 'Receiving', 'Damaged', 'Locked', 'Inbound']);

        let totalUnits = 0, totalValue = 0;
        rows.forEach(g => {
            const val = getRowValue(g);
            totalUnits += g.total;
            totalValue += val;
            const loc = g.locations || {};
            const avgCost = g.costCount > 0 ? Math.round(g.totalCost / g.costCount) : '';
            wsData.push([
                g.model, g.storage, g.brand,
                g.grades.A || '', g.grades.B || '', g.grades['C (AMZ)'] || '', g.grades.C || '', g.grades.D || '', g.grades.Damaged || '', g.grades.Defective || '', g.grades.RAW || '',
                g.total, g.price > 0 ? g.price : '', avgCost, val > 0 ? val : '',
                loc['Ready Room'] || '', loc['Processing'] || '', loc['Receiving'] || '',
                loc['Damaged'] || '', loc['Locked'] || '', loc['Inbound'] || ''
            ]);
        });
        wsData.push([]);
        wsData.push(['', '', '', '', '', '', 'TOTALS', totalUnits, '', totalValue]);

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!cols'] = [
            { wch: 36 }, { wch: 8 }, { wch: 10 },
            { wch: 5 }, { wch: 5 }, { wch: 8 }, { wch: 5 },
            { wch: 7 }, { wch: 8 }, { wch: 10 },
            { wch: 11 }, { wch: 11 }, { wch: 10 }, { wch: 9 }, { wch: 8 }, { wch: 9 }
        ];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Catalog');
        const fileName = `Universal_Catalog_${now.toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast(`Exported ${rows.length} models as Excel`, 'success');
    }

    function openExportModal() {
        const rows = getExportRows();
        let units = 0, val = 0;
        rows.forEach(g => { units += g.total; val += getRowValue(g); });
        document.getElementById('previewModels').textContent = rows.length.toLocaleString();
        document.getElementById('previewUnits').textContent = units.toLocaleString();
        document.getElementById('previewValue').textContent = '$' + val.toLocaleString();
        const em = document.getElementById('exportModal');
        em.classList.add('visible', 'active');
        const emInner = em.querySelector('.modal');
        if (emInner) emInner.classList.add('active');
    }
    function closeExportModal() { 
        const em = document.getElementById('exportModal');
        em.classList.remove('visible', 'active');
        const emInner = em.querySelector('.modal');
        if (emInner) emInner.classList.remove('active');
    }

    function getExportRows() {
        if (selectedRows.size > 0) return inventoryGroups.filter(g => selectedRows.has(g.key));
        return inventoryGroups;
    }

    function downloadExport() {
        const rows = getExportRows();
        const buyer = document.getElementById('buyerName').value.trim();
        const notes = document.getElementById('offerNotes').value.trim();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const csv = [];
        const d = v => (v > 0 ? v : '-');
        csv.push(csvLine(['UNICEL STOCK BREAKDOWN — Offer Sheet']));
        csv.push(csvLine(['Date', dateStr]));
        if (buyer) csv.push(csvLine(['Buyer', buyer]));
        if (notes) csv.push(csvLine(['Notes', notes]));
        csv.push('');
        csv.push(csvLine(['MODEL', 'STORAGE', 'A', 'B', 'C (AMZ)', 'C', 'D', 'DAMAGED', 'DEFECTIVE', 'RAW', 'TOTAL', 'PRICE', 'VALUE']));
        let totalUnits = 0, totalValue = 0;
        rows.forEach(g => {
            const val = getRowValue(g);
            totalUnits += g.total;
            totalValue += val;
            csv.push(csvLine([
                g.model, g.storage,
                d(g.grades.A), d(g.grades.B), d(g.grades['C (AMZ)']), d(g.grades.C), d(g.grades.D), d(g.grades.Damaged), d(g.grades.Defective), d(g.grades.RAW),
                g.total, g.price > 0 ? g.price : '', val > 0 ? val : ''
            ]));
        });
        csv.push('');
        csv.push(csvLine(['', '', '', '', '', '', totalUnits, 'TOTALS', totalValue]));
        const blob = new Blob(['\uFEFF' + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Offer_${buyer ? buyer.replace(/\s+/g, '_') + '_' : ''}${now.toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        closeExportModal();
        showToast(`Exported ${rows.length} models`, 'success');
    }

    function csvLine(vals) {
        return vals.map(v => { const s = String(v ?? ''); return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replace(/"/g, '""') + '"' : s; }).join(',');
    }

    /* ══════════════════════════════════════════════════════════
       UI HELPERS
       ══════════════════════════════════════════════════════════ */
    function showLoading(show, text) { const el = document.getElementById('loadingOverlay'); if (show) { el.classList.remove('hidden'); if (text) document.getElementById('loadingText').textContent = text; } else { el.classList.add('hidden'); } }
    function showError(msg) { document.getElementById('errorText').textContent = msg; document.getElementById('errorBanner').classList.add('visible'); }
    function showToast(msg, type = 'success') { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3500); }
    // Light mode only
    function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function escJs(s) { return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'"); }

    /* ══════════════════════════════════════════════════════════
       PRICE HISTORY MODAL
       ══════════════════════════════════════════════════════════ */
    async function showPriceHistory(model, storage) {
        let modal = document.getElementById('priceHistoryModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'priceHistoryModal';
            modal.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);';
            modal.innerHTML = `<div style="background:var(--bg-primary,#fff);border-radius:12px;padding:24px;max-width:480px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 id="histTitle" style="margin:0;font-size:16px;color:var(--text-primary,#111);">Price History</h3>
                    <button onclick="document.getElementById('priceHistoryModal').style.display='none'" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-secondary,#666);">✕</button>
                </div>
                <div id="histBody" style="font-size:14px;color:var(--text-primary,#111);"></div>
            </div>`;
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });
        }
        modal.style.display = 'flex';
        document.getElementById('histTitle').textContent = `${model} ${storage} — Price History`;
        const body = document.getElementById('histBody');
        body.innerHTML = '<p style="color:var(--text-secondary,#888);">Loading...</p>';
        try {
            const res = await fetch(`/api/price-history?model=${encodeURIComponent(model)}&storage=${encodeURIComponent(storage)}`);
            const data = await res.json();
            if (!data.history || data.history.length === 0) {
                body.innerHTML = '<p style="color:var(--text-secondary,#888);">No price history yet. Save a price to start tracking.</p>';
                return;
            }
            body.innerHTML = `<table style="width:100%;border-collapse:collapse;">
                <thead><tr><th style="text-align:left;padding:8px 4px;border-bottom:2px solid var(--border-default,#ddd);font-size:12px;text-transform:uppercase;color:var(--text-secondary,#888);">Price</th><th style="text-align:left;padding:8px 4px;border-bottom:2px solid var(--border-default,#ddd);font-size:12px;text-transform:uppercase;color:var(--text-secondary,#888);">Date</th><th style="text-align:right;padding:8px 4px;border-bottom:2px solid var(--border-default,#ddd);font-size:12px;text-transform:uppercase;color:var(--text-secondary,#888);">Change</th></tr></thead>
                <tbody>${data.history.map((h, i) => {
                    const prev = data.history[i + 1];
                    const diff = prev ? h.price - prev.price : 0;
                    const diffStr = diff === 0 ? '—' : (diff > 0 ? `<span style="color:#22c55e;">+$${diff.toFixed(0)}</span>` : `<span style="color:#ef4444;">-$${Math.abs(diff).toFixed(0)}</span>`);
                    const d = new Date(h.created_at);
                    return `<tr><td style="padding:6px 4px;border-bottom:1px solid var(--border-default,#eee);font-weight:600;">$${parseFloat(h.price).toFixed(0)}</td><td style="padding:6px 4px;border-bottom:1px solid var(--border-default,#eee);color:var(--text-secondary,#888);">${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td><td style="padding:6px 4px;border-bottom:1px solid var(--border-default,#eee);text-align:right;">${diffStr}</td></tr>`;
                }).join('')}</tbody></table>`;
        } catch (e) {
            body.innerHTML = `<p style="color:#ef4444;">Failed to load history: ${e.message}</p>`;
        }
    }
    </script>
</body>
</html>
