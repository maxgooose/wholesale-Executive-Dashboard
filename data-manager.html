<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#fafafa">
    <title>Universal - Data Manager</title>
    
    <!-- Theme Switcher (load first to prevent flash) -->
    <script src="scripts/theme-switcher.js"></script>
    
    <!-- Design System -->
    <link rel="stylesheet" href="styles/theme.css">
    
    <style>
        /* Page-specific styles */
        .main-content {
            padding: var(--space-6) 0;
            flex: 1;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.1);
        }

        /* Batch Info Banner */
        .batch-banner {
            background: var(--bg-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .batch-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--text-sm);
        }

        .batch-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-subtle);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        /* Analytics Overview */
        .analytics-bar {
            background: var(--bg-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .analytics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 1024px) {
            .analytics-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .analytics-grid { grid-template-columns: 1fr; }
        }

        .analytics-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
        }

        .analytics-item-label {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-tertiary);
            margin-bottom: var(--space-1);
        }

        .analytics-item-value {
            font-family: var(--font-mono);
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Data Table Section */
        .table-section {
            background: var(--bg-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
        }

        .table-title-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .table-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .search-input {
            width: 280px;
        }

        /* Empty State */
        .empty-state {
            padding: var(--space-12);
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            color: var(--text-muted);
        }

        .empty-title {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .empty-desc {
            font-size: var(--text-sm);
            color: var(--text-tertiary);
            margin-bottom: var(--space-6);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            padding: var(--space-3) var(--space-4);
            font-family: var(--font-display);
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-default);
            text-align: left;
            position: sticky;
            top: 0;
        }

        .data-table th.text-center,
        .data-table td.text-center {
            text-align: center;
        }

        .data-table td {
            padding: var(--space-3) var(--space-4);
            font-size: var(--text-sm);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table tbody tr {
            transition: background var(--transition-fast);
        }

        .data-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .data-table tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        .data-table tbody tr:nth-child(even):hover {
            background: var(--bg-hover);
        }

        .model-cell {
            font-weight: 500;
            max-width: 300px;
        }

        .storage-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            font-weight: 500;
            background: var(--bg-hover);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
        }

        .grade-count {
            font-family: var(--font-mono);
            font-weight: 500;
        }

        .grade-count.has-value {
            color: var(--text-primary);
        }

        .grade-count.zero {
            color: var(--text-muted);
        }

        .total-count {
            font-family: var(--font-mono);
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Pricing table: price below count */
        .grade-price {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        /* Row pricing indicators */
        .row-priced {
            border-left: 3px solid var(--positive);
        }

        .row-unpriced {
            border-left: 3px solid var(--border-subtle);
        }

        /* Group Row */
        .group-row {
            cursor: pointer;
            user-select: none;
        }

        .group-row:hover {
            background: var(--bg-hover) !important;
        }

        .group-toggle {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .group-toggle svg {
            width: 16px;
            height: 16px;
            color: var(--text-tertiary);
            transition: transform var(--transition-fast);
        }

        .group-row.expanded .group-toggle svg {
            transform: rotate(90deg);
        }

        .child-row {
            display: none;
        }

        .child-row.visible {
            display: table-row;
        }

        .child-row td:first-child {
            padding-left: var(--space-8);
        }

        /* Slide Panel - Export */
        .export-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-modal);
            transition: right var(--transition-slow);
            display: flex;
            flex-direction: column;
        }

        .export-panel.active {
            right: 0;
        }

        .export-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
        }

        .export-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
        }

        .export-panel-footer {
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }

        .export-section {
            margin-bottom: var(--space-6);
        }

        .export-section-title {
            font-family: var(--font-display);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .export-section-title svg {
            width: 16px;
            height: 16px;
            color: var(--text-tertiary);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
        }

        .export-option {
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--bg-secondary);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .export-option:hover {
            border-color: var(--border-strong);
        }

        .export-option.selected {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }

        .export-option input {
            margin-top: 2px;
        }

        .export-option-content {
            flex: 1;
        }

        .export-option-title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .export-option-desc {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .export-preview {
            background: var(--info-subtle);
            border: 1px solid var(--info);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-top: var(--space-4);
        }

        .export-preview-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--info);
            margin-bottom: var(--space-2);
        }

        .export-preview-text {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        /* Update History Panel */
        .history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-modal);
            transition: right var(--transition-slow);
            display: flex;
            flex-direction: column;
        }

        .history-panel.active {
            right: 0;
        }

        .history-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
        }

        .history-panel-body {
            flex: 1;
            overflow-y: auto;
        }

        .history-item {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
            transition: background var(--transition-fast);
        }

        .history-item:hover {
            background: var(--bg-hover);
        }

        .history-item-time {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-bottom: var(--space-1);
        }

        .history-item-title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .history-item-desc {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-top: var(--space-1);
        }

        /* Pricing Modal */
        .pricing-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: var(--z-overlay);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .pricing-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .pricing-modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform var(--transition-base);
        }

        .pricing-modal.active .pricing-modal-content {
            transform: scale(1);
        }

        .pricing-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
        }

        .pricing-modal-body {
            padding: var(--space-6);
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        /* Upload Modal */
        .upload-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: var(--z-overlay);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .upload-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .upload-modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform var(--transition-base);
        }

        .upload-modal.active .upload-modal-content {
            transform: scale(1);
        }

        .upload-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-subtle);
        }

        .upload-modal-body {
            padding: var(--space-6);
        }

        .upload-dropzone {
            border: 2px dashed var(--border-default);
            border-radius: var(--radius-xl);
            padding: var(--space-10);
            text-align: center;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragover {
            border-color: var(--accent);
            background: var(--accent-subtle);
        }

        .upload-dropzone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--space-4);
            color: var(--text-muted);
        }

        .upload-dropzone-text {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .upload-dropzone-hint {
            font-size: var(--text-sm);
            color: var(--text-muted);
        }

        .upload-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--border-subtle);
        }

        .upload-progress {
            margin-top: var(--space-4);
        }

        .upload-progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: var(--radius-full);
            transition: width var(--transition-base);
        }

        .upload-progress-text {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-top: var(--space-2);
        }

        /* Overlay */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: calc(var(--z-modal) - 1);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            width: 56px;
            height: 56px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            z-index: var(--z-dropdown);
        }

        .fab:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }

        .fab svg {
            width: 24px;
            height: 24px;
        }

        /* Connection Banner (inline, non-blocking) */
        .connection-banner {
            background: var(--bg-card);
            border: 1px solid var(--negative);
            border-left: 4px solid var(--negative);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-6);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: flex-start;
            gap: var(--space-4);
        }

        .connection-banner-icon {
            width: 40px;
            height: 40px;
            background: var(--negative-subtle);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--negative);
            flex-shrink: 0;
        }

        .connection-banner-body {
            flex: 1;
        }

        .connection-banner-title {
            font-family: var(--font-display);
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .connection-banner-desc {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
        }

        .connection-banner-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .connection-banner .upload-dropzone {
            padding: var(--space-4);
            margin-top: var(--space-3);
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animate-wrapper">
        <div class="bg-blob blob-1"></div>
        <div class="bg-blob blob-2"></div>
        <div class="bg-blob blob-3"></div>
    </div>

    <div class="page-wrapper">
        <!-- Header -->
        <header class="header no-print">
            <div class="header-inner">
                <div class="header-brand">
                    <div class="header-logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div>
                        <div class="header-title">Universal</div>
                        <div class="header-subtitle">Data Manager</div>
                    </div>
                </div>

                <nav class="header-nav">
                    <a href="dashboard_standalone.html" class="nav-link">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="data-manager.html" class="nav-link active">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        Data Manager
                    </a>
                    <a href="pricing-manager.html" class="nav-link">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Pricing
                    </a>
                    <a href="marketing.html" class="nav-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                    Marketing
                </a>
                </nav>

                <div class="header-actions">
                    <div class="sync-indicator" id="wholecellSyncStatus">
                        <span class="status-dot syncing"></span>
                        <span>Connecting...</span>
                    </div>

                    <button class="btn btn-ghost" onclick="refreshWholecellData()" title="Sync with Wholecell">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Refresh
                    </button>

                    <a href="pricing-manager.html" class="btn btn-secondary" style="text-decoration:none">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Pricing
                    </a>

                    <button class="btn btn-secondary" onclick="toggleHistoryPanel()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        History
                    </button>

                    <button class="btn btn-primary" onclick="openExportPanel()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Connection Error Banner (inline, non-blocking, hidden by default) -->
                <div id="connectionBanner" class="connection-banner hidden">
                    <div class="connection-banner-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <div class="connection-banner-body">
                        <div class="connection-banner-title">Unable to load inventory data</div>
                        <div class="connection-banner-desc" id="connectionBannerMessage">
                            Could not connect to Wholecell API. Upload a backup file or retry.
                        </div>
                        <div class="connection-banner-actions">
                            <button onclick="location.reload()" class="btn btn-sm btn-primary">Retry Connection</button>
                            <button onclick="openInventoryUploadModal()" class="btn btn-sm btn-secondary">Upload File</button>
                        </div>
                    </div>
                </div>

                <!-- Batch Info -->
                <div class="batch-banner" id="batchInfoBanner" style="display: none;">
                    <div class="batch-info">
                        <div class="batch-icon">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <span class="font-medium text-primary">Current Batch:</span>
                            <span class="text-secondary" id="batchInfo">Loading...</span>
                        </div>
                    </div>
                    <div class="text-xs text-muted" id="batchTimestamp"></div>
                </div>

                <!-- Analytics Overview -->
                <div class="analytics-bar">
                    <div class="analytics-header">
                        <h3 class="text-display font-semibold">Analytics Overview</h3>
                        <button class="btn btn-sm btn-secondary" onclick="openAnalyticsDashboard()">
                            Full Report
                        </button>
                    </div>
                    <div class="analytics-grid">
                        <div class="analytics-item">
                            <div class="analytics-item-label">Total Value</div>
                            <div class="analytics-item-value" id="totalInventoryValue">$0</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-item-label">Pricing Coverage</div>
                            <div class="analytics-item-value" id="pricingCoverage">0%</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-item-label">Avg Item Value</div>
                            <div class="analytics-item-value" id="avgItemValue">$0</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-item-label">Inventory Health</div>
                            <div class="analytics-item-value" id="inventoryHealth">--</div>
                        </div>
                    </div>
                </div>

                <!-- Data Table Section -->
                <div class="table-section">
                    <div class="table-header">
                        <div class="table-title-group">
                            <h3 class="text-display font-semibold">Inventory Summary</h3>
                            <div id="pricingCoverageIndicator"></div>
                        </div>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-ghost" onclick="toggleExpandAll()" id="expandAllBtn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                </svg>
                                <span id="expandAllText">Expand All</span>
                            </button>
                            <div class="input-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                <input type="text" id="searchInput" class="input search-input" placeholder="Search model...">
                            </div>
                            <button class="btn btn-sm btn-ghost text-negative" onclick="clearInventorySummary()" title="Clear all data">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Clear
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptySummaryState" class="empty-state hidden">
                        <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h4 class="empty-title">No Inventory Data</h4>
                        <p class="empty-desc">Upload your inventory file to view the summary breakdown</p>
                        <button class="btn btn-primary" onclick="openInventoryUploadModal()">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            Upload Inventory File
                        </button>
                    </div>

                    <!-- Summary Table -->
                    <div id="summaryTableContainer" class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th class="text-center">Storage</th>
                                    <th class="text-center">Grade A/A+</th>
                                    <th class="text-center">Grade B</th>
                                    <th class="text-center">Grade C</th>
                                    <th class="text-center">Grade D</th>
                                    <th class="text-center">Defective</th>
                                    <th class="text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Panel Overlay -->
        <div class="panel-overlay" id="panelOverlay" onclick="closeAllPanels()"></div>

        <!-- Export Panel -->
        <div class="export-panel" id="exportPanel">
            <div class="export-panel-header">
                <h3 class="text-display font-semibold">Export to Excel</h3>
                <button class="btn btn-ghost" onclick="closeExportPanel()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="export-panel-body">
                <!-- Data Source -->
                <div class="export-section">
                    <div class="export-section-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        Data Source
                    </div>
                    <div class="export-options">
                        <label class="export-option selected">
                            <input type="radio" name="dataSource" value="wholecell" checked>
                            <div class="export-option-content">
                                <div class="export-option-title">Wholecell Data</div>
                                <div class="export-option-desc">Current inventory</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="dataSource" value="upload">
                            <div class="export-option-content">
                                <div class="export-option-title">Upload Custom</div>
                                <div class="export-option-desc">One-time file</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Report Type -->
                <div class="export-section">
                    <div class="export-section-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Report Type
                    </div>
                    <div class="export-options">
                        <label class="export-option selected">
                            <input type="radio" name="reportType" value="grouped_breakdown" checked>
                            <div class="export-option-content">
                                <div class="export-option-title">Grouped</div>
                                <div class="export-option-desc">By model & storage</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="reportType" value="detailed_listing">
                            <div class="export-option-content">
                                <div class="export-option-title">Detailed</div>
                                <div class="export-option-desc">One row per item</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="reportType" value="pricing_breakdown">
                            <div class="export-option-content">
                                <div class="export-option-title">Pricing</div>
                                <div class="export-option-desc">With values</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="reportType" value="summary_report">
                            <div class="export-option-content">
                                <div class="export-option-title">Summary</div>
                                <div class="export-option-desc">High-level overview</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Filter -->
                <div class="export-section">
                    <div class="export-section-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                        </svg>
                        Data Filter
                    </div>
                    <div class="export-options">
                        <label class="export-option selected">
                            <input type="radio" name="dataFilter" value="everything" checked>
                            <div class="export-option-content">
                                <div class="export-option-title">Everything</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="dataFilter" value="recent_batch">
                            <div class="export-option-content">
                                <div class="export-option-title">Recent Batch</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="dataFilter" value="by_grade">
                            <div class="export-option-content">
                                <div class="export-option-title">By Grade</div>
                            </div>
                        </label>
                        <label class="export-option">
                            <input type="radio" name="dataFilter" value="by_status">
                            <div class="export-option-content">
                                <div class="export-option-title">By Status</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Preview -->
                <div class="export-preview">
                    <div class="export-preview-title">Export Preview</div>
                    <p class="export-preview-text" id="exportSummary">
                        Ready to export all inventory items with grouped breakdown format.
                    </p>
                </div>
            </div>
            <div class="export-panel-footer">
                <button class="btn btn-secondary" onclick="closeExportPanel()">Cancel</button>
                <button class="btn btn-primary" onclick="exportToExcel()">
                    <span id="exportSpinner" class="spinner hidden"></span>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <!-- History Panel -->
        <div class="history-panel" id="historyPanel">
            <div class="history-panel-header">
                <h3 class="text-display font-semibold">Update History</h3>
                <button class="btn btn-ghost" onclick="closeHistoryPanel()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="history-panel-body" id="updateHistory">
                <!-- History items will be populated here -->
            </div>
        </div>

        <!-- Upload Modal -->
        <div class="upload-modal" id="inventoryUploadModal">
            <div class="upload-modal-content">
                <div class="upload-modal-header">
                    <h3 class="text-display font-semibold">Upload Inventory</h3>
                    <button class="btn btn-ghost" onclick="closeInventoryUploadModal()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="upload-modal-body">
                    <div class="upload-dropzone" id="inventoryDropZone">
                        <svg class="upload-dropzone-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="upload-dropzone-text">Drag and drop your file here</p>
                        <p class="upload-dropzone-hint">Excel, CSV, or JSON</p>
                        <input type="file" id="inventoryFileModal" accept=".xlsx,.xls,.csv,.json" class="hidden">
                    </div>
                    <p class="text-sm text-muted text-center mt-4" id="selectedFileName">No file selected</p>
                    <div class="upload-progress hidden" id="updateProgressModal">
                        <div class="upload-progress-bar">
                            <div class="upload-progress-fill" style="width: 0%"></div>
                        </div>
                        <p class="upload-progress-text">Processing: <span id="updateStatusModal">0%</span></p>
                    </div>
                </div>
                <div class="upload-modal-footer">
                    <button class="btn btn-secondary" onclick="closeInventoryUploadModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="processInventoryUploadFromModal()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Process
                    </button>
                </div>
            </div>
        </div>

        <!-- Pricing Modal -->
        <div class="pricing-modal" id="pricingDashboard">
            <div class="pricing-modal-content">
                <div class="pricing-modal-header">
                    <h2 class="text-display font-bold text-xl">Pricing Manager</h2>
                    <button class="btn btn-ghost" onclick="closePricingDashboard()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="pricing-modal-body">
                    <div class="flex items-center justify-between mb-4">
                        <div class="input-icon" style="width: 280px;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" id="pricingSearch" class="input" placeholder="Search model...">
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-secondary" onclick="importPrices()">Import</button>
                            <button class="btn btn-secondary" onclick="exportPrices()">Export</button>
                            <button class="btn btn-primary" onclick="generateBreakdownSheet()">Generate Sheet</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Storage</th>
                                    <th class="text-center">A</th>
                                    <th class="text-center">B</th>
                                    <th class="text-center">C</th>
                                    <th class="text-center">C AMZ</th>
                                    <th class="text-center">D</th>
                                    <th class="text-center">Def</th>
                                    <th class="text-center">Total</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pricingTableBody">
                                <!-- Pricing rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAB -->
        <button class="fab no-print" onclick="openQuickAdd()" title="Quick Add">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
        </button>
    </div>

    <!-- Scripts -->
    <script src="wholecell-transformer.js"></script>
    <script src="wholecell-ui-enhancements.js"></script>
    <script src="room-workflow.js"></script>
    <script src="excel-export.js"></script>
    <script src="update-history.js"></script>
    <script src="pricing-db.js"></script>
    <script src="breakdown-modal.js"></script>
    <script src="inventory-updater.js"></script>
    <script src="pricing-analytics.js"></script>

    <script>
        // Panel Management
        function openExportPanel() {
            document.getElementById('exportPanel').classList.add('active');
            document.getElementById('panelOverlay').classList.add('active');
        }

        function closeExportPanel() {
            document.getElementById('exportPanel').classList.remove('active');
            document.getElementById('panelOverlay').classList.remove('active');
        }

        function openExcelExport() {
            openExportPanel();
        }

        function closeExcelExport() {
            closeExportPanel();
        }

        function toggleHistoryPanel() {
            document.getElementById('historyPanel').classList.toggle('active');
            document.getElementById('panelOverlay').classList.toggle('active');
        }

        function closeHistoryPanel() {
            document.getElementById('historyPanel').classList.remove('active');
            document.getElementById('panelOverlay').classList.remove('active');
        }

        function toggleUpdatePanel() {
            toggleHistoryPanel();
        }

        function closeAllPanels() {
            closeExportPanel();
            closeHistoryPanel();
        }

        // Export option selection
        document.querySelectorAll('.export-option input').forEach(input => {
            input.addEventListener('change', function() {
                const group = this.closest('.export-options');
                group.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
                this.closest('.export-option').classList.add('selected');
                updateExportPreview();
            });
        });

        function updateExportPreview() {
            const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const dataFilter = document.querySelector('input[name="dataFilter"]:checked').value;
            
            let text = `Ready to export `;
            text += dataFilter === 'everything' ? 'all inventory items' : dataFilter.replace('_', ' ');
            text += ` with ${reportType.replace('_', ' ')} format.`;
            
            document.getElementById('exportSummary').textContent = text;
        }

        // Pricing Dashboard
        function openPricingDashboard() {
            document.getElementById('pricingDashboard').classList.add('active');
            loadPricingDashboard();
        }

        function closePricingDashboard() {
            document.getElementById('pricingDashboard').classList.remove('active');
        }

        async function loadPricingDashboard() {
            try {
                await loadPricingTable();
            } catch (error) {
                console.error('Error loading pricing dashboard:', error);
            }
        }

        async function loadPricingTable(searchTerm = '') {
            try {
                // Build pricing-specific summary from filtered inventory data
                const pricingSummary = generatePricingSummary();
                let filteredData = pricingSummary;

                if (searchTerm) {
                    const search = searchTerm.toLowerCase();
                    filteredData = pricingSummary.filter(item =>
                        item.model.toLowerCase().includes(search) ||
                        item.storage.toLowerCase().includes(search)
                    );
                }

                const tbody = document.getElementById('pricingTableBody');

                if (filteredData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center py-8 text-muted">
                                No inventory data available. Please upload inventory file.
                            </td>
                        </tr>
                    `;
                    return;
                }

                const prices = await pricingDB.getAllPrices();
                const priceMap = {};
                prices.forEach(price => {
                    const key = `${price.model}_${price.storage}`;
                    priceMap[key] = price;
                });

                tbody.innerHTML = filteredData.map(item => {
                    const gradeA = (item.grades['A'] || 0) + (item.grades['A+'] || 0);
                    const gradeB = item.grades['B'] || 0;
                    const gradeC = item.grades['C'] || 0;
                    const gradeCAMZ = item.grades['C (AMZ)'] || 0;
                    const gradeD = item.grades['D'] || 0;
                    const defective = item.grades['Defective'] || 0;
                    const total = gradeA + gradeB + gradeC + gradeCAMZ + gradeD + defective;

                    const key = `${item.model}_${item.storage}`;
                    const pricing = priceMap[key];

                    const existingGrades = {
                        gradeA: (item.grades['A'] || 0) > 0,
                        gradeAPlus: (item.grades['A+'] || 0) > 0,
                        gradeB: gradeB > 0,
                        gradeC: gradeC > 0,
                        gradeCAMZ: gradeCAMZ > 0,
                        gradeD: gradeD > 0,
                        defective: defective > 0
                    };

                    // Helper: render count + price below
                    const gradeCell = (count, priceField) => {
                        const priceVal = pricing && pricing[priceField] ? `<div class="grade-price">$${pricing[priceField].toFixed(2)}</div>` : '';
                        return `<td class="text-center">
                            <span class="grade-count ${count > 0 ? 'has-value' : 'zero'}">${count}</span>
                            ${count > 0 ? priceVal : ''}
                        </td>`;
                    };

                    return `
                    <tr class="${pricing ? 'row-priced' : 'row-unpriced'}">
                        <td class="model-cell">${item.model}</td>
                        <td><span class="storage-badge">${item.storage}</span></td>
                        ${gradeCell(gradeA, 'gradeA')}
                        ${gradeCell(gradeB, 'gradeB')}
                        ${gradeCell(gradeC, 'gradeC')}
                        ${gradeCell(gradeCAMZ, 'gradeCAMZ')}
                        ${gradeCell(gradeD, 'gradeD')}
                        ${gradeCell(defective, 'defective')}
                        <td class="text-center total-count">${total}</td>
                        <td class="text-center">
                            <button onclick="editPriceWithGrades('${item.model.replace(/'/g, "\\'")}', '${item.storage}', ${JSON.stringify(existingGrades).replace(/"/g, '&quot;')})"
                                    class="btn btn-sm ${pricing ? 'btn-secondary' : 'btn-ghost text-accent'}">
                                ${pricing ? 'Edit' : '+ Set Price'}
                            </button>
                        </td>
                    </tr>
                `;
                }).join('');
            } catch (error) {
                console.error('Error loading pricing table:', error);
            }
        }

        // Generate pricing-specific summary: only Ready Room (AVAILABLE) + Processing Room (PROCESSING/empty)
        function generatePricingSummary() {
            const data = window.inventoryData || [];
            // Filter to only Ready Room + Processing Room items
            const filtered = data.filter(item => {
                const status = (item.STATUS || item.status || '').toUpperCase().trim();
                return status === 'AVAILABLE' || status === 'PROCESSING' || status === '';
            });

            const summaryMap = new Map();
            filtered.forEach(item => {
                const model = item.MODEL || 'Unknown Model';
                const storage = item.STORAGE || 'Unknown';
                const grade = item.GRADE || 'Unknown';
                const key = `${model}|${storage}`;

                if (!summaryMap.has(key)) {
                    summaryMap.set(key, {
                        model, storage,
                        grades: { 'A': 0, 'A+': 0, 'B': 0, 'C': 0, 'C (AMZ)': 0, 'D': 0, 'Defective': 0 }
                    });
                }

                const summary = summaryMap.get(key);
                if (summary.grades.hasOwnProperty(grade)) {
                    summary.grades[grade]++;
                } else if (grade.toUpperCase().includes('DEFECTIVE')) {
                    summary.grades['Defective']++;
                } else {
                    summary.grades['C']++;
                }
            });

            return Array.from(summaryMap.values()).sort((a, b) => {
                if (a.model !== b.model) return a.model.localeCompare(b.model);
                return a.storage.localeCompare(b.storage);
            });
        }

        document.getElementById('pricingSearch')?.addEventListener('input', (e) => {
            loadPricingTable(e.target.value);
        });

        function editPrice(model, storage) {
            if (typeof breakdownModal !== 'undefined' && breakdownModal && breakdownModal.openModal) {
                breakdownModal.openModal(model, storage);
            } else {
                console.error('breakdownModal not available');
                alert('Pricing modal not available. Please refresh the page.');
            }
        }

        function editPriceWithGrades(model, storage, existingGrades) {
            if (typeof breakdownModal !== 'undefined' && breakdownModal && breakdownModal.openModal) {
                breakdownModal.openModal(model, storage, existingGrades);
            } else {
                console.error('breakdownModal not available');
                alert('Pricing modal not available. Please refresh the page.');
            }
        }

        async function generateBreakdownSheet() {
            try {
                const prices = await pricingDB.getAllPrices();
                const breakdown = {};
                prices.forEach(price => {
                    if (!breakdown[price.model]) {
                        breakdown[price.model] = {};
                    }
                    breakdown[price.model][price.storage] = {
                        gradeA: price.gradeA,
                        gradeAPlus: price.gradeAPlus,
                        gradeB: price.gradeB,
                        gradeC: price.gradeC,
                        gradeCAMZ: price.gradeCAMZ,
                        gradeD: price.gradeD,
                        defective: price.defective,
                        total: price.total
                    };
                });

                await pricingDB.saveBreakdownSheet({
                    name: `Breakdown_${new Date().toISOString().split('T')[0]}`,
                    data: breakdown,
                    userId: 'System'
                });

                alert('Breakdown sheet generated successfully!');
                
                if (confirm('Would you like to export this to Excel?')) {
                    exportBreakdownToExcel(breakdown);
                }
            } catch (error) {
                console.error('Error generating breakdown:', error);
                alert('Failed to generate breakdown sheet');
            }
        }

        function exportBreakdownToExcel(breakdown) {
            let csv = 'PHONE/MODEL,STORAGE,A,A+,B,C,C (AMZ),D,DEFECTIVE,TOTAL\n';
            
            Object.entries(breakdown).forEach(([model, storages]) => {
                Object.entries(storages).forEach(([storage, prices]) => {
                    csv += `"${model}","${storage}",${prices.gradeA},${prices.gradeAPlus},${prices.gradeB},${prices.gradeC},${prices.gradeCAMZ},${prices.gradeD},${prices.defective},${prices.total}\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `breakdown_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        async function importPrices() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            await pricingDB.importData(data);
                            alert('Prices imported successfully!');
                            loadPricingDashboard();
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('Failed to import prices');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        async function exportPrices() {
            try {
                const data = await pricingDB.exportData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `pricing_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                alert('Prices exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export prices');
            }
        }

        document.addEventListener('pricesUpdated', () => {
            loadPricingDashboard();
        });

        // Analytics
        async function updateAnalyticsOverview() {
            try {
                if (typeof pricingAnalytics !== 'undefined') {
                    const summary = await pricingAnalytics.generateSummaryStats();
                    const inventory = await pricingAnalytics.analyzeInventory();
                    
                    document.getElementById('totalInventoryValue').textContent = 
                        `$${summary.totalInventoryValue.toFixed(2)}`;
                    document.getElementById('pricingCoverage').textContent = 
                        summary.pricingCoverage;
                    document.getElementById('avgItemValue').textContent = 
                        `$${summary.averageItemValue.toFixed(2)}`;
                    document.getElementById('inventoryHealth').textContent = 
                        inventory.inventoryHealth.status;
                }
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        async function openAnalyticsDashboard() {
            if (typeof pricingAnalytics === 'undefined') {
                alert('Analytics module not loaded');
                return;
            }
            
            const report = await pricingAnalytics.generatePricingReport();
            
            const modal = document.createElement('div');
            modal.className = 'pricing-modal active';
            modal.innerHTML = `
                <div class="pricing-modal-content" style="max-width: 900px;">
                    <div class="pricing-modal-header">
                        <h2 class="text-display font-bold text-xl">Analytics Report</h2>
                        <button class="btn btn-ghost" onclick="this.closest('.pricing-modal').remove()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="pricing-modal-body">
                        <div class="analytics-grid mb-6">
                            <div class="analytics-item">
                                <div class="analytics-item-label">Total Items</div>
                                <div class="analytics-item-value">${report.summary.totalInventoryItems}</div>
                            </div>
                            <div class="analytics-item">
                                <div class="analytics-item-label">Total Value</div>
                                <div class="analytics-item-value">$${report.summary.totalInventoryValue.toFixed(2)}</div>
                            </div>
                            <div class="analytics-item">
                                <div class="analytics-item-label">Coverage</div>
                                <div class="analytics-item-value">${report.summary.pricingCoverage}</div>
                            </div>
                        </div>
                        
                        <h4 class="text-display font-semibold mb-4">Recommendations</h4>
                        ${report.recommendations.map(rec => `
                            <div class="alert alert-${rec.type === 'warning' ? 'warning' : 'info'} mb-3">
                                <div class="alert-content">
                                    <div class="alert-title">${rec.title}</div>
                                    <div class="alert-description">${rec.description}</div>
                                </div>
                            </div>
                        `).join('')}
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="pricingAnalytics.exportAnalyticsReport('json')" class="btn btn-secondary">
                                Export JSON
                            </button>
                            <button onclick="pricingAnalytics.exportAnalyticsReport('csv')" class="btn btn-secondary">
                                Export CSV
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Upload Modal
        function openInventoryUploadModal() {
            document.getElementById('inventoryUploadModal').classList.add('active');
            initializeModalDragDrop();
        }

        function closeInventoryUploadModal() {
            document.getElementById('inventoryUploadModal').classList.remove('active');
            const fileInput = document.getElementById('inventoryFileModal');
            if (fileInput) fileInput.value = '';
            document.getElementById('selectedFileName').textContent = 'No file selected';
            document.getElementById('updateProgressModal').classList.add('hidden');
        }

        function initializeModalDragDrop() {
            const dropZone = document.getElementById('inventoryDropZone');
            const fileInput = document.getElementById('inventoryFileModal');

            if (!dropZone || !fileInput) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    document.getElementById('selectedFileName').textContent = files[0].name;
                }
            }, false);

            dropZone.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    document.getElementById('selectedFileName').textContent = e.target.files[0].name;
                }
            });
        }

        async function processInventoryUploadFromModal() {
            const fileInput = document.getElementById('inventoryFileModal');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload');
                return;
            }
            
            const progressDiv = document.getElementById('updateProgressModal');
            const progressBar = progressDiv.querySelector('.upload-progress-fill');
            const statusText = document.getElementById('updateStatusModal');
            
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            statusText.textContent = 'Reading file...';
            
            try {
                const result = await inventoryUpdater.processUploadedFile(file);
                
                progressBar.style.width = '100%';
                statusText.textContent = 'Complete!';
                
                let message = `Inventory updated!\n\nStrategy: ${result.strategy}`;
                if (result.added) message += `\nAdded: ${result.added}`;
                if (result.updated) message += `\nUpdated: ${result.updated}`;
                if (result.total) message += `\nTotal: ${result.total}`;
                
                alert(message);
                
                setTimeout(closeInventoryUploadModal, 1000);
                updateAnalyticsOverview();
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to process file: ' + error.message);
                progressDiv.classList.add('hidden');
            }
        }

        // Expand/Collapse
        let allExpanded = false;
        function toggleExpandAll() {
            allExpanded = !allExpanded;
            document.getElementById('expandAllText').textContent = allExpanded ? 'Collapse All' : 'Expand All';
            document.querySelectorAll('.group-row').forEach(row => {
                row.classList.toggle('expanded', allExpanded);
            });
            document.querySelectorAll('.child-row').forEach(row => {
                row.classList.toggle('visible', allExpanded);
            });
        }

        // Quick Add
        function openQuickAdd() {
            openInventoryUploadModal();
        }

        // Notification helper
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-success';
            notification.style.cssText = 'position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 1000; min-width: 300px;';
            notification.innerHTML = `
                <div class="alert-content">
                    <div class="alert-title">Success</div>
                    <div class="alert-description">${message}</div>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Clear inventory
        function clearInventorySummary() {
            if (confirm('Are you sure you want to clear all inventory data?')) {
                document.getElementById('dataTableBody').innerHTML = '';
                document.getElementById('emptySummaryState').classList.remove('hidden');
                document.getElementById('summaryTableContainer').classList.add('hidden');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateAnalyticsOverview();
            setInterval(updateAnalyticsOverview, 60000);
            updateExportPreview();
        });

        document.addEventListener('inventoryUpdate', () => {
            updateAnalyticsOverview();
        });
    </script>
</body>
</html>
