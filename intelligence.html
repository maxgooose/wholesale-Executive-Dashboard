<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Intelligence — Universal Cellular</title>
    <link rel="stylesheet" href="styles/theme.css">
    <script src="scripts/theme-switcher.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation */
        .nav {
            height: 52px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            padding: 0 var(--space-6);
            gap: var(--space-4);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(16px);
        }
        .nav-brand {
            font-weight: 700;
            font-size: var(--text-lg);
            color: var(--text-primary);
            text-decoration: none;
        }
        .nav-links {
            display: flex;
            gap: var(--space-1);
            margin-left: auto;
        }
        .nav-links a {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: var(--text-sm);
            font-weight: 500;
            transition: all 0.15s;
        }
        .nav-links a:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .nav-links a.active { background: var(--accent); color: white; }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* Header */
        .page-header {
            margin-bottom: var(--space-8);
        }
        .page-header h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: var(--space-2);
        }
        .page-header p {
            color: var(--text-secondary);
            font-size: var(--text-base);
        }
        .generated-at {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: var(--space-1);
        }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
        }
        .metric-label {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
        }
        .metric-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }
        .metric-sub {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-top: var(--space-2);
        }
        .metric-card.alert {
            border-color: #ef4444;
            background: color-mix(in srgb, #ef4444 5%, var(--bg-card));
        }
        .metric-card.alert .metric-value { color: #ef4444; }
        .metric-card.warning {
            border-color: #f59e0b;
            background: color-mix(in srgb, #f59e0b 5%, var(--bg-card));
        }
        .metric-card.warning .metric-value { color: #f59e0b; }
        .metric-card.good {
            border-color: #10b981;
            background: color-mix(in srgb, #10b981 5%, var(--bg-card));
        }
        .metric-card.good .metric-value { color: #10b981; }

        /* Sections */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        .section h2 {
            font-size: var(--text-xl);
            font-weight: 700;
            margin-bottom: var(--space-1);
        }
        .section-desc {
            color: var(--text-secondary);
            font-size: var(--text-sm);
            margin-bottom: var(--space-5);
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }
        .data-table th {
            text-align: left;
            padding: var(--space-3) var(--space-4);
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-subtle);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .data-table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border-subtle);
        }
        .data-table tr:hover td { background: var(--bg-secondary); }
        .data-table .num { text-align: right; font-variant-numeric: tabular-nums; }
        .data-table .highlight { font-weight: 700; }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
        }
        .tag-red { background: #fef2f2; color: #dc2626; }
        .tag-yellow { background: #fffbeb; color: #d97706; }
        .tag-green { background: #f0fdf4; color: #16a34a; }
        .tag-blue { background: #eff6ff; color: #2563eb; }
        .tag-gray { background: #f9fafb; color: #6b7280; }

        [data-theme="dark"] .tag-red { background: #450a0a; color: #fca5a5; }
        [data-theme="dark"] .tag-yellow { background: #451a03; color: #fcd34d; }
        [data-theme="dark"] .tag-green { background: #052e16; color: #86efac; }
        [data-theme="dark"] .tag-blue { background: #1e3a5f; color: #93c5fd; }
        [data-theme="dark"] .tag-gray { background: #1f2937; color: #9ca3af; }

        /* Charts */
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
        }
        .chart-card h3 {
            font-size: var(--text-base);
            font-weight: 700;
            margin-bottom: var(--space-4);
        }
        canvas { max-height: 300px; }

        /* Recommendations */
        .rec-list { list-style: none; }
        .rec-item {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            background: var(--bg-secondary);
        }
        .rec-priority {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: var(--text-sm);
            color: white;
        }
        .rec-priority.high { background: #ef4444; }
        .rec-priority.med { background: #f59e0b; }
        .rec-priority.low { background: #3b82f6; }
        .rec-content h4 { font-size: var(--text-sm); font-weight: 700; margin-bottom: 2px; }
        .rec-content p { font-size: var(--text-sm); color: var(--text-secondary); }

        /* Deal Analyzer */
        .deal-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: var(--space-3);
            align-items: end;
            margin-bottom: var(--space-5);
        }
        .deal-form label {
            display: block;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--space-1);
        }
        .deal-form input, .deal-form select {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: var(--text-sm);
            font-family: inherit;
        }
        .deal-form input:focus, .deal-form select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
        }
        .btn-analyze {
            padding: var(--space-2) var(--space-4);
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            font-size: var(--text-sm);
            white-space: nowrap;
        }
        .btn-analyze:hover { opacity: 0.9; }
        .deal-result {
            padding: var(--space-5);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            display: none;
        }
        .deal-result.show { display: block; }
        .deal-verdict {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: var(--space-3);
        }
        .deal-verdict.go { color: #10b981; }
        .deal-verdict.caution { color: #f59e0b; }
        .deal-verdict.nogo { color: #ef4444; }
        .deal-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }
        .deal-stat-label { font-size: var(--text-xs); color: var(--text-muted); }
        .deal-stat-value { font-size: var(--text-lg); font-weight: 700; }

        /* Loading */
        .loading { text-align: center; padding: var(--space-8); color: var(--text-muted); }

        @media (max-width: 768px) {
            .chart-row { grid-template-columns: 1fr; }
            .deal-form { grid-template-columns: 1fr; }
            .deal-stats { grid-template-columns: 1fr 1fr; }
            .metrics-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <a href="index.html" class="nav-brand">Universal</a>
        <div class="nav-links">
            <a href="index.html">Dashboard</a>
            <a href="data-manager.html">Data</a>
            <a href="pricing-manager.html">Pricing</a>
            <a href="intelligence.html" class="active">Intelligence</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Inventory Intelligence</h1>
            <p>Aging analysis, capital efficiency, and actionable recommendations</p>
            <div class="generated-at" id="generatedAt"></div>
        </div>

        <div class="loading" id="loadingMsg">Analyzing inventory data...</div>

        <div id="content" style="display:none;">
            <!-- KPI Cards -->
            <div class="metrics-grid" id="metrics"></div>

            <!-- Charts -->
            <div class="chart-row">
                <div class="chart-card">
                    <h3>Inventory Age Distribution</h3>
                    <canvas id="ageChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Capital by Grade</h3>
                    <canvas id="gradeChart"></canvas>
                </div>
            </div>
            <div class="chart-row">
                <div class="chart-card">
                    <h3>Top 10 Models by Quantity</h3>
                    <canvas id="modelChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Top 10 Models by Capital Tied Up</h3>
                    <canvas id="capitalChart"></canvas>
                </div>
            </div>

            <!-- Deal Analyzer -->
            <div class="section">
                <h2>Deal Analyzer</h2>
                <p class="section-desc">Evaluate incoming deals against your current inventory costs and market position</p>
                <div class="deal-form">
                    <div>
                        <label>Device Model</label>
                        <input type="text" id="dealModel" placeholder="e.g. iPhone 13" list="modelList">
                        <datalist id="modelList"></datalist>
                    </div>
                    <div>
                        <label>Grade</label>
                        <select id="dealGrade">
                            <option value="A">A</option>
                            <option value="B" selected>B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="RAW">RAW</option>
                        </select>
                    </div>
                    <div>
                        <label>Quantity</label>
                        <input type="number" id="dealQty" value="100" min="1">
                    </div>
                    <div>
                        <label>Price Per Unit ($)</label>
                        <input type="number" id="dealPrice" placeholder="180" step="0.01">
                    </div>
                    <button class="btn-analyze" onclick="analyzeDeal()">Analyze</button>
                </div>
                <div class="deal-result" id="dealResult"></div>
            </div>

            <!-- Aging Alert Table -->
            <div class="section">
                <h2>Aging Inventory Alert</h2>
                <p class="section-desc">Models with significant capital sitting over 60 days — prioritize for liquidation or repricing</p>
                <table class="data-table" id="agingTable">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Units 60-90d</th>
                            <th>Units 90d+</th>
                            <th class="num">Avg Cost/Unit</th>
                            <th class="num">Capital at Risk</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="agingBody"></tbody>
                </table>
            </div>

            <!-- Location Efficiency -->
            <div class="section">
                <h2>Location Efficiency</h2>
                <p class="section-desc">Where items are sitting and how long they've been there</p>
                <table class="data-table" id="locationTable">
                    <thead>
                        <tr>
                            <th>Location</th>
                            <th class="num">Units</th>
                            <th class="num">Capital</th>
                            <th class="num">Avg Age (days)</th>
                            <th class="num">% Over 60d</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="locationBody"></tbody>
                </table>
            </div>

            <!-- Recommendations -->
            <div class="section">
                <h2>Recommendations</h2>
                <p class="section-desc">AI-generated action items based on current inventory state</p>
                <ul class="rec-list" id="recList"></ul>
            </div>
        </div>
    </div>

    <script>
    let inventoryData = [];

    async function loadData() {
        try {
            const resp = await fetch('/api/inventory');
            const json = await resp.json();
            inventoryData = json.data || json;
            runAnalysis();
        } catch (e) {
            // Fallback: try local file
            try {
                const resp = await fetch('/data/available-inventory.json');
                const json = await resp.json();
                inventoryData = json.data || json;
                runAnalysis();
            } catch (e2) {
                document.getElementById('loadingMsg').textContent = 'Failed to load inventory data: ' + e2.message;
            }
        }
    }

    function fmt(n) { return new Intl.NumberFormat('en-US').format(n); }
    function fmtMoney(n) { return '$' + new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n); }
    function daysSince(dateStr) { return (Date.now() - new Date(dateStr).getTime()) / 86400000; }

    function runAnalysis() {
        const items = inventoryData;
        const now = Date.now();
        document.getElementById('loadingMsg').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('generatedAt').textContent = 'Generated: ' + new Date().toLocaleString();

        // Compute core metrics
        const totalItems = items.length;
        const totalCost = items.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100;
        const avgAge = items.reduce((s, i) => s + daysSince(i.created_at), 0) / totalItems;
        const over60 = items.filter(i => daysSince(i.created_at) > 60);
        const over90 = items.filter(i => daysSince(i.created_at) > 90);
        const over60Cost = over60.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100;
        const over90Cost = over90.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100;
        const readyRoom = items.filter(i => i.location?.name === 'Ready Room');
        const damaged = items.filter(i => i.location?.name === 'Damaged');
        const damagedCost = damaged.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100;

        // KPI Cards
        const metricsHtml = `
            <div class="metric-card">
                <div class="metric-label">Total Inventory</div>
                <div class="metric-value">${fmt(totalItems)}</div>
                <div class="metric-sub">${fmtMoney(totalCost)} total cost basis</div>
            </div>
            <div class="metric-card good">
                <div class="metric-label">Ready to Sell</div>
                <div class="metric-value">${fmt(readyRoom.length)}</div>
                <div class="metric-sub">${(readyRoom.length / totalItems * 100).toFixed(1)}% of inventory</div>
            </div>
            <div class="metric-card ${over90.length > totalItems * 0.3 ? 'alert' : 'warning'}">
                <div class="metric-label">Over 90 Days</div>
                <div class="metric-value">${fmt(over90.length)}</div>
                <div class="metric-sub">${fmtMoney(over90Cost)} capital at risk</div>
            </div>
            <div class="metric-card ${damaged.length > totalItems * 0.25 ? 'alert' : 'warning'}">
                <div class="metric-label">Damaged</div>
                <div class="metric-value">${fmt(damaged.length)}</div>
                <div class="metric-sub">${fmtMoney(damagedCost)} tied up</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Age</div>
                <div class="metric-value">${avgAge.toFixed(0)}d</div>
                <div class="metric-sub">Average days in inventory</div>
            </div>
            <div class="metric-card warning">
                <div class="metric-label">Capital Over 60 Days</div>
                <div class="metric-value">${fmtMoney(over60Cost)}</div>
                <div class="metric-sub">${(over60Cost / totalCost * 100).toFixed(1)}% of total investment</div>
            </div>
        `;
        document.getElementById('metrics').innerHTML = metricsHtml;

        // Age Distribution Chart
        const ageBuckets = [
            { label: '< 7 days', count: 0, cost: 0 },
            { label: '7-30 days', count: 0, cost: 0 },
            { label: '30-60 days', count: 0, cost: 0 },
            { label: '60-90 days', count: 0, cost: 0 },
            { label: '90-180 days', count: 0, cost: 0 },
            { label: '180+ days', count: 0, cost: 0 },
        ];
        items.forEach(i => {
            const age = daysSince(i.created_at);
            const cost = (i.total_price_paid || 0) / 100;
            const idx = age < 7 ? 0 : age < 30 ? 1 : age < 60 ? 2 : age < 90 ? 3 : age < 180 ? 4 : 5;
            ageBuckets[idx].count++;
            ageBuckets[idx].cost += cost;
        });

        new Chart(document.getElementById('ageChart'), {
            type: 'bar',
            data: {
                labels: ageBuckets.map(b => b.label),
                datasets: [{
                    label: 'Units',
                    data: ageBuckets.map(b => b.count),
                    backgroundColor: ['#10b981', '#34d399', '#fbbf24', '#f59e0b', '#ef4444', '#991b1b'],
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // Grade Chart
        const grades = {};
        items.forEach(i => {
            const g = i.product_variation?.grade || 'Unknown';
            if (!grades[g]) grades[g] = { count: 0, cost: 0 };
            grades[g].count++;
            grades[g].cost += (i.total_price_paid || 0) / 100;
        });
        const gradeEntries = Object.entries(grades).sort((a, b) => b[1].cost - a[1].cost);
        const gradeColors = { A: '#10b981', B: '#34d399', C: '#fbbf24', 'C (AMZ)': '#f59e0b', D: '#ef4444', RAW: '#6b7280', UNGRADED: '#9ca3af', NEW: '#3b82f6' };

        new Chart(document.getElementById('gradeChart'), {
            type: 'doughnut',
            data: {
                labels: gradeEntries.map(([g]) => g),
                datasets: [{
                    data: gradeEntries.map(([, v]) => Math.round(v.cost)),
                    backgroundColor: gradeEntries.map(([g]) => gradeColors[g] || '#6b7280'),
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmtMoney(ctx.raw)}` } }
                }
            }
        });

        // Top Models by Quantity
        const models = {};
        items.forEach(i => {
            const m = i.product_variation?.product?.model || 'Unknown';
            if (!models[m]) models[m] = { count: 0, cost: 0, ages: [] };
            models[m].count++;
            models[m].cost += (i.total_price_paid || 0) / 100;
            models[m].ages.push(daysSince(i.created_at));
        });
        const topByQty = Object.entries(models).sort((a, b) => b[1].count - a[1].count).slice(0, 10);
        const topByCost = Object.entries(models).sort((a, b) => b[1].cost - a[1].cost).slice(0, 10);

        new Chart(document.getElementById('modelChart'), {
            type: 'bar',
            data: {
                labels: topByQty.map(([m]) => m.length > 25 ? m.slice(0, 22) + '...' : m),
                datasets: [{
                    label: 'Units',
                    data: topByQty.map(([, v]) => v.count),
                    backgroundColor: '#3b82f6',
                    borderRadius: 6,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });

        new Chart(document.getElementById('capitalChart'), {
            type: 'bar',
            data: {
                labels: topByCost.map(([m]) => m.length > 25 ? m.slice(0, 22) + '...' : m),
                datasets: [{
                    label: 'Capital ($)',
                    data: topByCost.map(([, v]) => Math.round(v.cost)),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 6,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => fmtMoney(ctx.raw) } }
                },
                scales: { x: { beginAtZero: true, ticks: { callback: v => fmtMoney(v) } } }
            }
        });

        // Populate model datalist for deal analyzer
        const allModels = Object.keys(models).sort();
        const dl = document.getElementById('modelList');
        allModels.forEach(m => { const o = document.createElement('option'); o.value = m; dl.appendChild(o); });

        // Aging Alert Table
        const agingAlerts = Object.entries(models)
            .map(([model, data]) => {
                const over60Items = data.ages.filter(a => a > 60 && a <= 90).length;
                const over90Items = data.ages.filter(a => a > 90).length;
                const atRiskCost = items.filter(i =>
                    (i.product_variation?.product?.model || 'Unknown') === model && daysSince(i.created_at) > 60
                ).reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100;
                return { model, over60Items, over90Items, avgCost: data.cost / data.count, atRiskCost, total: data.count };
            })
            .filter(r => r.over90Items > 10 || r.atRiskCost > 5000)
            .sort((a, b) => b.atRiskCost - a.atRiskCost)
            .slice(0, 20);

        const agingBody = document.getElementById('agingBody');
        agingAlerts.forEach(r => {
            const pctOld = ((r.over60Items + r.over90Items) / r.total * 100).toFixed(0);
            const action = r.over90Items > r.total * 0.5 ? '<span class="tag tag-red">Liquidate</span>'
                : r.over90Items > 20 ? '<span class="tag tag-yellow">Reprice</span>'
                : '<span class="tag tag-blue">Monitor</span>';
            agingBody.innerHTML += `<tr>
                <td class="highlight">${r.model}</td>
                <td class="num">${r.over60Items}</td>
                <td class="num">${r.over90Items}</td>
                <td class="num">${fmtMoney(r.avgCost)}</td>
                <td class="num highlight">${fmtMoney(r.atRiskCost)}</td>
                <td>${action}</td>
            </tr>`;
        });

        // Location Efficiency Table
        const locations = {};
        items.forEach(i => {
            const loc = i.location?.name || 'Unknown';
            if (!locations[loc]) locations[loc] = { count: 0, cost: 0, ages: [] };
            locations[loc].count++;
            locations[loc].cost += (i.total_price_paid || 0) / 100;
            locations[loc].ages.push(daysSince(i.created_at));
        });

        const locBody = document.getElementById('locationBody');
        Object.entries(locations)
            .sort((a, b) => b[1].cost - a[1].cost)
            .forEach(([loc, data]) => {
                const avgAgeLoc = data.ages.reduce((s, a) => s + a, 0) / data.ages.length;
                const pctOver60 = (data.ages.filter(a => a > 60).length / data.ages.length * 100).toFixed(1);
                const status = pctOver60 > 50 ? '<span class="tag tag-red">Stale</span>'
                    : pctOver60 > 25 ? '<span class="tag tag-yellow">Aging</span>'
                    : '<span class="tag tag-green">Healthy</span>';
                locBody.innerHTML += `<tr>
                    <td class="highlight">${loc}</td>
                    <td class="num">${fmt(data.count)}</td>
                    <td class="num">${fmtMoney(data.cost)}</td>
                    <td class="num">${avgAgeLoc.toFixed(0)}</td>
                    <td class="num">${pctOver60}%</td>
                    <td>${status}</td>
                </tr>`;
            });

        // Generate Recommendations
        generateRecommendations(items, models, locations, over60Cost, over90, damaged, totalCost);
    }

    function generateRecommendations(items, models, locations, over60Cost, over90, damaged, totalCost) {
        const recs = [];

        // Aging capital
        const over60Pct = (over60Cost / totalCost * 100);
        if (over60Pct > 30) {
            recs.push({
                priority: 'high',
                title: `${over60Pct.toFixed(0)}% of capital is in 60+ day inventory`,
                desc: `${fmtMoney(over60Cost)} sitting in aging stock. Focus on liquidating the oldest items first — even at a loss, freeing capital for fresh inventory is often more profitable.`
            });
        }

        // Damaged inventory
        const damagedPct = (damaged.length / items.length * 100);
        if (damagedPct > 20) {
            const damagedCost = damaged.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100;
            recs.push({
                priority: 'high',
                title: `${damaged.length} items (${damagedPct.toFixed(0)}%) in Damaged location`,
                desc: `${fmtMoney(damagedCost)} in damaged stock. Evaluate repair vs. salvage for high-value items. Batch-sell low-value damaged units to parts dealers.`
            });
        }

        // RAW/Ungraded
        const rawUngraded = items.filter(i => ['RAW', 'UNGRADED'].includes(i.product_variation?.grade));
        if (rawUngraded.length > items.length * 0.5) {
            recs.push({
                priority: 'med',
                title: `${rawUngraded.length} items (${(rawUngraded.length/items.length*100).toFixed(0)}%) are RAW or UNGRADED`,
                desc: `Grading unlocks higher sale prices. Prioritize grading for high-demand models (iPhones, iPads) — graded B units typically sell for 15-25% more than RAW.`
            });
        }

        // Receiving bottleneck
        const receiving = locations['Receiving'];
        if (receiving && receiving.count > 2000) {
            const avgAge = receiving.ages.reduce((s, a) => s + a, 0) / receiving.ages.length;
            recs.push({
                priority: avgAge > 30 ? 'high' : 'med',
                title: `${receiving.count} items stuck in Receiving (avg ${avgAge.toFixed(0)} days)`,
                desc: `Processing bottleneck detected. Items in Receiving aren't generating revenue. Increase processing throughput or reallocate staff to clear the backlog.`
            });
        }

        // Concentration risk
        const topModel = Object.entries(models).sort((a, b) => b[1].cost - a[1].cost)[0];
        if (topModel) {
            const pct = (topModel[1].cost / totalCost * 100);
            if (pct > 15) {
                recs.push({
                    priority: 'med',
                    title: `${topModel[0]} represents ${pct.toFixed(1)}% of capital`,
                    desc: `High concentration risk. If ${topModel[0]} prices drop, exposure is ${fmtMoney(topModel[1].cost)}. Consider diversifying or reducing position.`
                });
            }
        }

        // Quick wins
        const readyGradedA = items.filter(i => i.location?.name === 'Ready Room' && i.product_variation?.grade === 'A');
        if (readyGradedA.length > 0) {
            recs.push({
                priority: 'low',
                title: `${readyGradedA.length} Grade A items ready to sell`,
                desc: `These are your highest-margin items. Ensure they're listed at premium prices on all channels.`
            });
        }

        const recList = document.getElementById('recList');
        recs.forEach(r => {
            recList.innerHTML += `<li class="rec-item">
                <div class="rec-priority ${r.priority}">${r.priority === 'high' ? '!' : r.priority === 'med' ? '~' : 'i'}</div>
                <div class="rec-content">
                    <h4>${r.title}</h4>
                    <p>${r.desc}</p>
                </div>
            </li>`;
        });

        if (recs.length === 0) {
            recList.innerHTML = '<li class="rec-item"><div class="rec-content"><p>Inventory looks healthy. No urgent actions needed.</p></div></li>';
        }
    }

    // Deal Analyzer
    function analyzeDeal() {
        const modelInput = document.getElementById('dealModel').value.trim().toUpperCase();
        const grade = document.getElementById('dealGrade').value;
        const qty = parseInt(document.getElementById('dealQty').value);
        const price = parseFloat(document.getElementById('dealPrice').value);

        if (!modelInput || !price) return;

        // Find matching items in inventory
        const matching = inventoryData.filter(i => {
            const m = (i.product_variation?.product?.model || '').toUpperCase();
            return m.includes(modelInput) || modelInput.includes(m);
        });

        const sameGrade = matching.filter(i => i.product_variation?.grade === grade);
        const avgCostAll = matching.length > 0
            ? matching.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100 / matching.length
            : 0;
        const avgCostGrade = sameGrade.length > 0
            ? sameGrade.reduce((s, i) => s + (i.total_price_paid || 0), 0) / 100 / sameGrade.length
            : avgCostAll;

        const totalDealCost = qty * price;
        const refCost = avgCostGrade || avgCostAll;
        const costDiff = refCost > 0 ? ((price - refCost) / refCost * 100) : 0;
        const currentQty = matching.length;

        // Verdict
        let verdict, verdictClass;
        if (refCost === 0) {
            verdict = 'NO DATA — New model, can\'t compare';
            verdictClass = 'caution';
        } else if (price < refCost * 0.85) {
            verdict = 'STRONG BUY — Below your average cost';
            verdictClass = 'go';
        } else if (price < refCost * 1.0) {
            verdict = 'GOOD DEAL — At or below cost basis';
            verdictClass = 'go';
        } else if (price < refCost * 1.15) {
            verdict = 'FAIR — Slightly above your avg cost';
            verdictClass = 'caution';
        } else {
            verdict = 'PASS — Too expensive vs. your cost basis';
            verdictClass = 'nogo';
        }

        const resultDiv = document.getElementById('dealResult');
        resultDiv.className = 'deal-result show';
        resultDiv.innerHTML = `
            <div class="deal-verdict ${verdictClass}">${verdict}</div>
            <div class="deal-stats">
                <div>
                    <div class="deal-stat-label">Deal Total</div>
                    <div class="deal-stat-value">${fmtMoney(totalDealCost)}</div>
                </div>
                <div>
                    <div class="deal-stat-label">Your Avg Cost (${grade})</div>
                    <div class="deal-stat-value">${refCost > 0 ? fmtMoney(refCost) : 'N/A'}</div>
                </div>
                <div>
                    <div class="deal-stat-label">Price vs. Avg</div>
                    <div class="deal-stat-value" style="color: ${costDiff < 0 ? '#10b981' : costDiff > 10 ? '#ef4444' : '#f59e0b'}">${costDiff > 0 ? '+' : ''}${costDiff.toFixed(1)}%</div>
                </div>
                <div>
                    <div class="deal-stat-label">Already In Stock</div>
                    <div class="deal-stat-value">${fmt(currentQty)}</div>
                </div>
            </div>
            ${currentQty > 500 ? '<p style="margin-top:12px;color:var(--text-secondary);font-size:var(--text-sm);">You already have ' + fmt(currentQty) + ' of this model. Adding ' + fmt(qty) + ' more increases concentration risk.</p>' : ''}
        `;
    }

    loadData();
    </script>
</body>
</html>
