<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#fafafa">
    <title>Universal - Executive Dashboard</title>
    
    <!-- Theme Switcher (load first to prevent flash) -->
    <script src="scripts/theme-switcher.js"></script>
    
    <!-- Design System -->
    <link rel="stylesheet" href="styles/theme.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Hero Section */
        .hero-section {
            margin-bottom: var(--space-8);
            animation: slideDown 0.6s ease-out;
        }

        .hero-glass {
            background: var(--bg-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-subtle);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-4) var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-8);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* Animated Greeting */
        .greeting-wrapper {
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .greeting-line {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            animation: rollout 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .greeting-line.delayed {
            animation-delay: 0.8s;
        }

        @keyframes rollout {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-greeting {
            min-width: 240px;
            border-right: 1px solid var(--border-subtle);
            padding-right: var(--space-6);
            position: relative;
            z-index: 2;
        }

        .hero-greeting h2 {
            font-size: var(--text-xl);
            margin-bottom: 2px;
            line-height: 1.2;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--text-primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-pulse-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            mask-image: linear-gradient(90deg, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(90deg, transparent, black 5%, black 95%, transparent);
        }

        .hero-pulse-track {
            display: flex;
            gap: var(--space-8);
            animation: marquee 30s linear infinite;
            white-space: nowrap;
        }

        .hero-pulse-track:hover {
            animation-play-state: paused;
        }

        .pulse-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .pulse-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            color: var(--accent);
        }

        .pulse-value {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--text-primary);
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .hero-glass {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-4);
            }
            
            .hero-greeting {
                border-right: none;
                border-bottom: 1px solid var(--border-subtle);
                padding-right: 0;
                padding-bottom: var(--space-4);
                width: 100%;
            }
            
            .hero-pulse-wrapper {
                width: 100%;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }

        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-6);
            margin-bottom: var(--space-6);
        }

        @media (max-width: 1024px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        .chart-card {
            /* Inherits from .card in theme.css, specialized overrides here if needed */
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-family: var(--font-display);
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .chart-title svg {
            width: 18px;
            height: 18px;
            color: var(--text-tertiary);
        }

        .chart-wrapper {
            height: 280px;
            position: relative;
        }

        /* Attention Section */
        .attention-section {
            margin-bottom: var(--space-6);
        }

        .attention-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .attention-icon {
            width: 32px;
            height: 32px;
            background: var(--negative-subtle);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--negative);
        }

        .attention-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 1024px) {
            .attention-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .attention-grid { grid-template-columns: 1fr; }
        }

        .attention-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border-left: 4px solid var(--border-strong);
            transition: all var(--transition-fast);
        }

        .attention-item:hover {
            transform: translateX(4px);
        }

        .attention-item.critical { border-left-color: var(--negative); }
        .attention-item.warning { border-left-color: var(--warning); }
        .attention-item.info { border-left-color: var(--info); }
        .attention-item.processing { border-left-color: var(--accent); }

        .attention-item-title {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .attention-item-value {
            font-family: var(--font-mono);
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .attention-item-desc {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* Stations Chart Section */
        .stations-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }

        .stations-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .stations-chart-wrapper {
            height: 220px;
        }

        /* Last updated footer */
        .footer-info {
            margin-top: var(--space-8);
            padding-top: var(--space-4);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--text-xs);
            color: var(--text-muted);
        }

        /* Global Search Styles */
        #globalSearch::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        #globalSearch:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
        }
        
        .search-result-item:last-child {
            border-bottom: none !important;
        }

        /* Mobile search adjustments */
        @media (max-width: 768px) {
            .search-wrapper {
                order: -1;
                width: 100%;
            }
            #globalSearch {
                width: 100% !important;
            }
            .header-actions {
                flex-wrap: wrap;
                gap: var(--space-2);
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animate-wrapper">
        <div class="bg-blob blob-1"></div>
        <div class="bg-blob blob-2"></div>
        <div class="bg-blob blob-3"></div>
    </div>

    <div class="page-wrapper">
        <!-- Header -->
        <header class="header no-print">
            <div class="header-inner">
                <div class="header-brand">
                    <div class="header-logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div>
                        <div class="header-title">Universal</div>
                        <div class="header-subtitle">Executive Dashboard</div>
                    </div>
                </div>

                <nav class="header-nav">
                    <a href="dashboard_standalone.html" class="nav-link active">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="data-manager.html" class="nav-link">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        Data Manager
                    </a>
                    <a href="pricing-manager.html" class="nav-link">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Pricing
                    </a>
                    <a href="marketing.html" class="nav-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                    Marketing
                </a>
                </nav>

                <div class="header-actions">
                    <!-- Quick Search -->
                    <div class="search-wrapper" style="position:relative;">
                        <input type="text" id="globalSearch" class="input" placeholder="Search IMEI, model, brand..." 
                               style="width:220px;padding-left:36px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;" 
                               oninput="handleGlobalSearch(this.value)">
                        <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:rgba(255,255,255,0.6);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <div id="searchResults" class="search-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;max-height:300px;overflow-y:auto;margin-top:4px;z-index:1000;box-shadow:0 8px 32px rgba(0,0,0,0.2);"></div>
                    </div>

                    <div class="sync-indicator" id="syncStatus" title="Click to refresh" style="cursor:pointer;" onclick="refreshData()">
                        <span class="status-dot online" id="syncDot"></span>
                        <span id="syncText">Live</span>
                    </div>
                    
                    <!-- Export CSV Button -->
                    <button class="btn btn-secondary" onclick="exportToCSV()" title="Export filtered inventory to CSV" style="padding:8px 12px;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        CSV
                    </button>
                    
                    <select id="statusFilter" class="btn btn-secondary" style="cursor:pointer;padding:8px 12px;font-size:13px;border-radius:8px;" onchange="onFilterChange()">
                        <option value="all">All Statuses</option>
                    </select>

                    <select id="locationFilter" class="btn btn-secondary" style="cursor:pointer;padding:8px 12px;font-size:13px;border-radius:8px;" onchange="onFilterChange()">
                        <option value="all">All Locations</option>
                    </select>

                    <button class="btn btn-primary" onclick="refreshData()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Hero Section: Executive Pulse -->
                <section class="hero-section no-print">
                    <div class="hero-glass">
                        <div class="hero-greeting">
                            <div class="greeting-wrapper">
                                <h2 class="greeting-line" id="greetingText">Good Morning,</h2>
                                <h2 class="greeting-line delayed gradient-text">Yossi</h2>
                            </div>
                        </div>
                        
                        <div class="hero-pulse-wrapper">
                            <div class="hero-pulse-track" id="pulseTrack">
                                <!-- Items will be duplicated for seamless loop -->
                                <div class="pulse-item">
                                    <div class="pulse-icon">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <span>System Status: <span class="pulse-value text-positive js-hero-status">Operational</span></span>
                                </div>
                                <div class="pulse-item">
                                    <div class="pulse-icon">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <span>Est. Value: <span class="pulse-value js-hero-value">Loading...</span></span>
                                </div>
                                <div class="pulse-item">
                                    <div class="pulse-icon">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                                    </div>
                                    <span>New Inventory: <span class="pulse-value text-accent js-hero-new-inventory">Loading...</span></span>
                                </div>
                                <div class="pulse-item">
                                    <div class="pulse-icon">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <span>Processing: <span class="pulse-value text-warning js-hero-processing">Loading...</span></span>
                                </div>
                                <div class="pulse-item">
                                    <div class="pulse-icon">
                                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    </div>
                                    <span>Avg Turnaround: <span class="pulse-value js-hero-avg-turnaround">Loading...</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Inventory</div>
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-meta">Lifetime: <span id="lifetimeCount">0</span> units</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Available Units</div>
                        <div class="stat-value positive" id="availableUnits">0</div>
                        <div class="stat-meta"><span id="availablePercent">0</span>% ready to ship</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Processing</div>
                        <div class="stat-value warning" id="processingUnits">0</div>
                        <div class="stat-meta">At <span id="stationCount">19</span> stations</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Est. Value</div>
                        <div class="stat-value accent" id="estValue">$0</div>
                        <div class="stat-meta">Avg: <span id="avgValue">$0</span>/unit</div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="charts-grid">
                    <div class="card chart-card">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                            </svg>
                            Brand Distribution
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="brandChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Grade Distribution
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="gradeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="charts-grid">
                    <div class="card chart-card">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Inventory Aging (Days in Stock)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="agingChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Battery Health Distribution
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="batteryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 3 (Models & Storage) -->
                <div class="charts-grid">
                    <div class="card chart-card">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                            </svg>
                            Top 10 Models by Volume
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="topModelsChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                            </svg>
                            Storage Capacity Distribution
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="storageChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Attention Items REMOVED -->

                <!-- Processing Stations -->
                <section class="stations-section">
                    <div class="stations-header">
                        <div class="chart-title">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            Processing Stations Workload
                        </div>
                    </div>
                    <div class="stations-chart-wrapper">
                        <canvas id="stationsChart"></canvas>
                    </div>
                </section>

                <!-- Footer Info -->
                <footer class="footer-info no-print">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div id="lastUpdated">Last updated: --</div>
                        <span id="autoRefreshIndicator" style="font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:4px;">
                            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Auto-refresh: <span id="refreshCountdown">5:00</span>
                        </span>
                    </div>
                    <div>Universal Executive Dashboard v2.1</div>
                </footer>
            </div>
        </main>
    </div>

    <!-- Data & Scripts -->
    <script src="wholecell-transformer.js"></script>
    <!-- preloaded.js removed — data loads from data/available-inventory.json -->
    <script>
        let inventoryData = [];
        let allInventoryData = []; // unfiltered copy
        let charts = {};

        // Chart.js theme configuration
        function getChartColors() {
            const colors = {
                primary: '#0ea5e9',
                secondary: '#8b5cf6',
                positive: '#10b981',
                warning: '#f59e0b',
                negative: '#ef4444',
                accent: '#ec4899',
                text: '#0f172a',
                textMuted: '#64748b',
                grid: 'rgba(0, 0, 0, 0.05)',
                border: 'rgba(0, 0, 0, 0.1)',
                shadow: 'rgba(0, 0, 0, 0.1)'
            };
            return { ...colors, isDark: false };
        }

        function getChartDefaults() {
            const colors = getChartColors();
            Chart.defaults.color = colors.textMuted;
            Chart.defaults.borderColor = colors.border;
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: colors.text,
                            font: { family: "'IBM Plex Mono', monospace", size: 11, weight: '500' },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 8
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: colors.text,
                        bodyColor: colors.textMuted,
                        borderColor: colors.border,
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        boxPadding: 6
                    }
                },
                scales: {
                    x: {
                        ticks: { color: colors.textMuted, font: { size: 11 } },
                        grid: { color: colors.grid, drawBorder: false }
                    },
                    y: {
                        ticks: { color: colors.textMuted, font: { size: 11 } },
                        grid: { color: colors.grid, drawBorder: false },
                        beginAtZero: true
                    }
                },
                elements: {
                    bar: {
                        borderRadius: 8,
                        borderSkipped: false
                    },
                    arc: {
                        borderWidth: 0,
                        hoverOffset: 10
                    }
                }
            };
        }

        async function loadData() {
            try {
                // Priority 1: Load from local available-inventory.json snapshot (15K+ items)
                try {
                    const response = await fetch('data/available-inventory.json');
                    if (response.ok) {
                        const rawData = await response.json();
                        if (rawData.data && Array.isArray(rawData.data) && rawData.data.length > 0) {
                            const transformedItems = WholecellTransformer.transformAll(rawData.data);
                            allInventoryData = transformedItems;
                            inventoryData = transformedItems;
                            document.getElementById('lastUpdated').textContent = `${rawData.count || rawData.data.length} items loaded`;
                            populateFilters();
                            updateDashboard();
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Could not load local snapshot, trying backup...', e);
                }

                // No additional fallbacks — data/available-inventory.json is the single source
                console.error('Failed to load inventory data from data/available-inventory.json');
                allInventoryData = [];
                inventoryData = [];
                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                allInventoryData = [];
                inventoryData = [];
                updateDashboard();
            }
        }

        // Populate both filter dropdowns
        function populateFilters() {
            // Status filter
            const statusSelect = document.getElementById('statusFilter');
            if (statusSelect) {
                const statusCounts = {};
                allInventoryData.forEach(item => {
                    const s = item.STATUS || 'Unknown';
                    statusCounts[s] = (statusCounts[s] || 0) + 1;
                });
                const sortedStatuses = Object.entries(statusCounts).sort((a, b) => b[1] - a[1]);
                const currentStatus = statusSelect.value;
                statusSelect.innerHTML = '';

                const allStatusOpt = document.createElement('option');
                allStatusOpt.value = 'all';
                allStatusOpt.textContent = `All Statuses (${allInventoryData.length})`;
                statusSelect.appendChild(allStatusOpt);

                sortedStatuses.forEach(([status, count]) => {
                    const opt = document.createElement('option');
                    opt.value = status;
                    opt.textContent = `${status} (${count})`;
                    statusSelect.appendChild(opt);
                });

                if (currentStatus && currentStatus !== 'all') {
                    statusSelect.value = sortedStatuses.some(([s]) => s === currentStatus) ? currentStatus : 'all';
                }
            }

            // Location filter
            populateLocationFilter();
        }

        function populateLocationFilter() {
            const select = document.getElementById('locationFilter');
            if (!select) return;

            // Use currently filtered data (after status filter) to show relevant locations
            const sourceData = getStatusFilteredData();
            const locationCounts = {};
            sourceData.forEach(item => {
                const loc = item.location || 'No Location';
                locationCounts[loc] = (locationCounts[loc] || 0) + 1;
            });

            const sorted = Object.entries(locationCounts).sort((a, b) => b[1] - a[1]);
            const current = select.value;
            select.innerHTML = '';

            const allOpt = document.createElement('option');
            allOpt.value = 'all';
            allOpt.textContent = `All Locations (${sourceData.length})`;
            select.appendChild(allOpt);

            sorted.forEach(([loc, count]) => {
                const opt = document.createElement('option');
                opt.value = loc;
                opt.textContent = `${loc} (${count})`;
                select.appendChild(opt);
            });

            if (current && current !== 'all') {
                select.value = sorted.some(([l]) => l === current) ? current : 'all';
            }
        }

        function getStatusFilteredData() {
            const statusSelect = document.getElementById('statusFilter');
            const status = statusSelect ? statusSelect.value : 'all';
            if (status === 'all') return allInventoryData;
            return allInventoryData.filter(item => (item.STATUS || 'Unknown') === status);
        }

        // Handle any filter change
        function onFilterChange() {
            const statusFiltered = getStatusFilteredData();

            // Update location filter options based on status selection
            populateLocationFilter();

            const locSelect = document.getElementById('locationFilter');
            const loc = locSelect ? locSelect.value : 'all';

            if (loc === 'all') {
                inventoryData = statusFiltered;
            } else {
                inventoryData = statusFiltered.filter(item => (item.location || 'No Location') === loc);
            }

            updateDashboard();
        }

        function updateDashboard() {
            updateKeyMetrics();
            updateCharts();
        }

        function updateKeyMetrics() {
            const totalItems = inventoryData.length;
            
            // Calculate Real Value (Sum of cost)
            // Note: We use 'cost' which comes from 'total_price_paid' in the transformer
            const totalValue = inventoryData.reduce((sum, item) => sum + (item.cost || 0), 0);
            
            const uniqueModels = new Set(inventoryData.map(item => item.MODEL)).size;
            
            // Status Counts
            const availableUnits = inventoryData.filter(item => (item.STATUS || '').toUpperCase() === 'AVAILABLE').length;
            // Processing is anything not Sold and not Available
            const processingUnits = inventoryData.filter(item => {
                const s = (item.STATUS || '').toUpperCase();
                return s !== 'SOLD' && s !== 'AVAILABLE';
            }).length;
            
            // NEW: Active Inventory Calculation
            const activeInventoryCount = availableUnits + processingUnits;

            const availablePercent = totalItems > 0 ? ((availableUnits / totalItems) * 100).toFixed(1) : 0;

            // Update Stats Grid
            document.getElementById('totalItems').textContent = activeInventoryCount.toLocaleString();
            document.getElementById('lifetimeCount').textContent = totalItems.toLocaleString();
            document.getElementById('availableUnits').textContent = availableUnits.toLocaleString();
            document.getElementById('availablePercent').textContent = availablePercent;
            document.getElementById('processingUnits').textContent = processingUnits.toLocaleString();
            
            // Update Value with Real Money (or $0 if costs aren't tracked)
            document.getElementById('estValue').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(totalValue);
            
            // Calculate Avg Value
            const avgVal = totalItems > 0 ? totalValue / totalItems : 0;
            document.getElementById('avgValue').textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(avgVal);

            // Update Hero Pulse
            // Use totalValue if available, otherwise calculate based on a default to show *something* if costs are missing
            const displayValue = totalValue > 0 ? totalValue : (totalItems * 150); 
            
            // Helper to update all instances of a class (because marquee clones nodes)
            const updateAll = (selector, text, className) => {
                document.querySelectorAll(selector).forEach(el => {
                    el.textContent = text;
                    if (className) el.className = className;
                });
            };

            updateAll('.js-hero-value', new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: "compact" }).format(displayValue));
            updateAll('.js-hero-processing', processingUnits.toLocaleString() + ' Units');

            // Update Status
            const statusText = inventoryData.length > 0 ? 'Operational' : 'No Data';
            const statusClass = inventoryData.length > 0 ? 'pulse-value text-positive js-hero-status' : 'pulse-value text-negative js-hero-status';
            updateAll('.js-hero-status', statusText, statusClass);

            // Calculate New Inventory (Created in last 24 hours)
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            const newInventoryCount = inventoryData.filter(item => {
                if (!item.created_at) return false;
                const created = new Date(item.created_at);
                return created >= oneDayAgo;
            }).length;
            updateAll('.js-hero-new-inventory', `+${newInventoryCount} Units`);

            // Calculate Avg Turnaround (for SOLD items)
            let totalTurnaroundDays = 0;
            let soldItemsCount = 0;
            inventoryData.forEach(item => {
                if ((item.STATUS || '').toUpperCase() === 'SOLD' && item.created_at && item.lastUpdated) {
                    const created = new Date(item.created_at);
                    const sold = new Date(item.lastUpdated);
                    const diffTime = Math.abs(sold - created);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if (diffDays >= 0) {
                         totalTurnaroundDays += diffDays;
                         soldItemsCount++;
                    }
                }
            });
            const avgTurnaround = soldItemsCount > 0 ? (totalTurnaroundDays / soldItemsCount).toFixed(1) : "0.0";
            updateAll('.js-hero-avg-turnaround', `${avgTurnaround} Days`);
            
            // Initialize Marquee (Duplicate content for seamless loop)
            initMarquee();
        }

        let marqueeInitialized = false;
        function initMarquee() {
            if (marqueeInitialized) return;
            const track = document.getElementById('pulseTrack');
            if (track) {
                // Clone children to ensure there's enough content for the loop
                const items = Array.from(track.children);
                items.forEach(item => {
                    const clone = item.cloneNode(true);
                    track.appendChild(clone);
                });
                // Double it again to be safe for wide screens
                items.forEach(item => {
                    const clone = item.cloneNode(true);
                    track.appendChild(clone);
                });
                marqueeInitialized = true;
            }
        }

        function updateCharts() {
            createBrandChart();
            createGradeChart();
            createAgingChart();
            createBatteryChart();
            createTopModelsChart();
            createStorageChart();
            createStationsChart();
        }

        function createAgingChart() {
            const colors = getChartColors();
            const agingBuckets = {
                '0-30 Days': 0,
                '31-60 Days': 0,
                '61-90 Days': 0,
                '90+ Days': 0
            };
            
            const now = new Date();
            
            inventoryData.forEach(item => {
                // Only count unsold inventory for aging
                const status = (item.STATUS || '').toUpperCase();
                if (status === 'SOLD' || status === 'SHIPPED') return;
                
                if (item.created_at) {
                    const created = new Date(item.created_at);
                    const days = Math.floor((now - created) / (1000 * 60 * 60 * 24));
                    
                    if (days <= 30) agingBuckets['0-30 Days']++;
                    else if (days <= 60) agingBuckets['31-60 Days']++;
                    else if (days <= 90) agingBuckets['61-90 Days']++;
                    else agingBuckets['90+ Days']++;
                }
            });

            if (charts.agingChart) charts.agingChart.destroy();
            charts.agingChart = new Chart(document.getElementById('agingChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(agingBuckets),
                    datasets: [{
                        label: 'Units',
                        data: Object.values(agingBuckets),
                        backgroundColor: [colors.positive, colors.primary, colors.warning, colors.negative],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    ...getChartDefaults(),
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createBatteryChart() {
            const colors = getChartColors();
            const buckets = {
                '100%': 0,
                '90-99%': 0,
                '80-89%': 0,
                '<80%': 0,
                'Service': 0
            };

            inventoryData.forEach(item => {
                // Check both custom fields and dedicated column if exists
                let health = item['BATTERY HEALTH'] || item.custom_field_values?.['Battery Health'];
                
                if (health) {
                    health = String(health).trim();
                    
                    if (health.toLowerCase().includes('service')) {
                        buckets['Service']++;
                    } else {
                        const pct = parseInt(health.replace('%', ''));
                        if (!isNaN(pct)) {
                            if (pct === 100) buckets['100%']++;
                            else if (pct >= 90) buckets['90-99%']++;
                            else if (pct >= 80) buckets['80-89%']++;
                            else buckets['<80%']++;
                        }
                    }
                }
            });

            if (charts.batteryChart) charts.batteryChart.destroy();
            charts.batteryChart = new Chart(document.getElementById('batteryChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(buckets),
                    datasets: [{
                        data: Object.values(buckets),
                        backgroundColor: [colors.positive, colors.primary, colors.secondary, colors.warning, colors.negative],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                font: { family: "'IBM Plex Mono', monospace", size: 11 },
                                padding: 16,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createBrandChart() {
            const colors = getChartColors();
            const brandData = {};
            inventoryData.forEach(item => {
                // Use the manufacturer field directly instead of pattern matching
                let brand = (item.manufacturer || '').trim().toUpperCase();
                if (!brand || brand === 'UNKNOWN') {
                    brand = 'OTHER';
                }
                // Normalize brand name for display (Title Case)
                brand = brand.charAt(0).toUpperCase() + brand.slice(1).toLowerCase();
                brandData[brand] = (brandData[brand] || 0) + 1;
            });
            
            // Sort by count and take top brands, group rest as "Other"
            const sortedBrands = Object.entries(brandData)
                .sort((a, b) => b[1] - a[1]);
            
            const topBrands = sortedBrands.slice(0, 6);
            const otherCount = sortedBrands.slice(6).reduce((sum, [_, count]) => sum + count, 0);
            
            const finalBrandData = {};
            topBrands.forEach(([brand, count]) => {
                finalBrandData[brand] = count;
            });
            if (otherCount > 0) {
                finalBrandData['Other'] = (finalBrandData['Other'] || 0) + otherCount;
            }

            if (charts.brandChart) charts.brandChart.destroy();
            charts.brandChart = new Chart(document.getElementById('brandChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(finalBrandData),
                    datasets: [{
                        data: Object.values(finalBrandData),
                        backgroundColor: [colors.primary, colors.secondary, colors.accent, colors.warning, colors.positive, '#8B5CF6', '#EC4899', '#14B8A6'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                font: { family: "'IBM Plex Mono', monospace", size: 11 },
                                padding: 16,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createGradeChart() {
            const colors = getChartColors();
            const gradeData = { 'A': 0, 'B': 0, 'C': 0, 'C (AMZ)': 0, 'D': 0, 'LOCKED': 0 };
            inventoryData.forEach(item => {
                const grade = item.GRADE || 'Unknown';
                const status = (item.STATUS || '').toUpperCase();
                if (status.includes('LOCKED')) gradeData['LOCKED']++;
                else if (grade === 'A') gradeData['A']++;
                else if (grade === 'B') gradeData['B']++;
                else if (grade === 'C (AMZ)') gradeData['C (AMZ)']++;
                else if (grade === 'C') gradeData['C']++;
                else if (grade === 'D') gradeData['D']++;
            });

            if (charts.gradeChart) charts.gradeChart.destroy();
            charts.gradeChart = new Chart(document.getElementById('gradeChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(gradeData),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(gradeData),
                        backgroundColor: [colors.positive, colors.primary, colors.warning, colors.secondary, colors.negative, colors.textMuted],
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    ...getChartDefaults(),
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createTopModelsChart() {
            const colors = getChartColors();
            const modelData = {};
            inventoryData.forEach(item => {
                const model = item.MODEL || 'Unknown';
                modelData[model] = (modelData[model] || 0) + 1;
            });
            const topModels = Object.entries(modelData).sort((a, b) => b[1] - a[1]).slice(0, 10);

            if (charts.topModelsChart) charts.topModelsChart.destroy();
            charts.topModelsChart = new Chart(document.getElementById('topModelsChart'), {
                type: 'bar',
                data: {
                    labels: topModels.map(m => m[0].length > 25 ? m[0].substring(0, 25) + '...' : m[0]),
                    datasets: [{
                        label: 'Volume',
                        data: topModels.map(m => m[1]),
                        backgroundColor: colors.positive,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    ...getChartDefaults(),
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function createStorageChart() {
            const colors = getChartColors();
            const storageData = {};
            inventoryData.forEach(item => {
                const storage = item.STORAGE || 'Unknown';
                storageData[storage] = (storageData[storage] || 0) + 1;
            });

            if (charts.storageChart) charts.storageChart.destroy();
            charts.storageChart = new Chart(document.getElementById('storageChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(storageData),
                    datasets: [{
                        data: Object.values(storageData),
                        backgroundColor: [colors.negative, colors.warning, colors.positive, colors.primary, colors.secondary, colors.accent, '#6366f1'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                font: { family: "'IBM Plex Mono', monospace", size: 11 },
                                padding: 16,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createStationsChart() {
            const colors = getChartColors();
            
            // Count items per location using Real Data
            const locationCounts = {};
            inventoryData.forEach(item => {
                // Use the location name from transformation, or 'Unknown'
                const loc = item.location || 'Unknown';
                // Skip 'Sold' or 'Shipped' if you want to focus on operational workload
                if (loc === 'Sold' || loc === 'Shipped') return; 
                locationCounts[loc] = (locationCounts[loc] || 0) + 1;
            });

            // Sort by count descending
            const sortedLocations = Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 19); // Top 19

            // If no location data, fallback to dummy (or show empty)
            // But since we have real data, we'll use it. 
            // If the array is empty (e.g. everything Sold), handle gracefully
            let stations = sortedLocations.map(x => x[0]);
            let workloads = sortedLocations.map(x => x[1]);
            
            if (stations.length === 0) {
                stations = ['No Active Stations'];
                workloads = [0];
            }

            if (charts.stationsChart) charts.stationsChart.destroy();
            charts.stationsChart = new Chart(document.getElementById('stationsChart'), {
                type: 'bar',
                data: {
                    labels: stations,
                    datasets: [{
                        label: 'Units',
                        data: workloads,
                        backgroundColor: colors.warning,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    ...getChartDefaults(),
                    scales: {
                        ...getChartDefaults().scales,
                        y: {
                            ...getChartDefaults().scales.y,
                            // Remove fixed max since real data varies
                            suggestedMax: Math.max(...workloads) * 1.1
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
        }

        function refreshData() {
            loadData();
        }

        // Listen for theme changes and update charts
        window.addEventListener('themechange', () => {
            updateCharts();
        });

        // ============================================
        // SMART GREETING (EST timezone aware)
        // ============================================
        function updateGreeting() {
            const greetingEl = document.getElementById('greetingText');
            if (!greetingEl) return;
            
            // Get current time in EST (America/New_York)
            const now = new Date();
            const estTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const hour = estTime.getHours();
            
            let greeting;
            if (hour >= 5 && hour < 12) {
                greeting = 'Good Morning,';
            } else if (hour >= 12 && hour < 17) {
                greeting = 'Good Afternoon,';
            } else if (hour >= 17 && hour < 21) {
                greeting = 'Good Evening,';
            } else {
                greeting = 'Good Night,';
            }
            
            greetingEl.textContent = greeting;
        }

        // ============================================
        // QUICK SEARCH (IMEI, Model, Brand)
        // ============================================
        let searchTimeout = null;
        function handleGlobalSearch(query) {
            const resultsEl = document.getElementById('searchResults');
            if (!resultsEl) return;
            
            if (!query || query.length < 2) {
                resultsEl.style.display = 'none';
                return;
            }
            
            // Debounce the search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const q = query.toLowerCase().trim();
                const matches = allInventoryData.filter(item => {
                    const imei = (item.IMEI || '').toLowerCase();
                    const model = (item.MODEL || '').toLowerCase();
                    const brand = (item.manufacturer || '').toLowerCase();
                    const serial = (item.serial || '').toLowerCase();
                    return imei.includes(q) || model.includes(q) || brand.includes(q) || serial.includes(q);
                }).slice(0, 10); // Limit to 10 results
                
                if (matches.length === 0) {
                    resultsEl.innerHTML = '<div style="padding:12px;color:var(--text-muted);text-align:center;">No results found</div>';
                } else {
                    resultsEl.innerHTML = matches.map(item => `
                        <div class="search-result-item" style="padding:10px 12px;border-bottom:1px solid var(--border-subtle);cursor:pointer;transition:background 0.15s;" 
                             onmouseover="this.style.background='var(--bg-hover)'" 
                             onmouseout="this.style.background='transparent'"
                             onclick="viewDeviceDetails('${item.IMEI || item.serial || ''}')">
                            <div style="font-weight:600;color:var(--text-primary);font-size:13px;">${item.MODEL || 'Unknown Model'}</div>
                            <div style="display:flex;gap:12px;font-size:11px;color:var(--text-tertiary);margin-top:2px;">
                                <span>${item.manufacturer || 'Unknown'}</span>
                                <span>•</span>
                                <span>${item.GRADE || 'N/A'}</span>
                                <span>•</span>
                                <span style="font-family:var(--font-mono);">${item.IMEI || item.serial || 'No ID'}</span>
                            </div>
                            <div style="font-size:10px;margin-top:3px;">
                                <span class="badge" style="background:${item.STATUS === 'AVAILABLE' ? 'var(--positive-subtle)' : 'var(--warning-subtle)'};color:${item.STATUS === 'AVAILABLE' ? 'var(--positive)' : 'var(--warning)'};padding:2px 6px;font-size:9px;">${item.STATUS || 'Unknown'}</span>
                                <span style="color:var(--text-muted);margin-left:8px;">${item.location || 'No Location'}</span>
                            </div>
                        </div>
                    `).join('');
                }
                
                resultsEl.style.display = 'block';
            }, 150);
        }
        
        function viewDeviceDetails(imei) {
            // Navigate to data manager with the IMEI filter
            if (imei) {
                window.location.href = `data-manager.html?search=${encodeURIComponent(imei)}`;
            }
        }
        
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const searchWrapper = document.querySelector('.search-wrapper');
            const resultsEl = document.getElementById('searchResults');
            if (searchWrapper && resultsEl && !searchWrapper.contains(e.target)) {
                resultsEl.style.display = 'none';
            }
        });

        // ============================================
        // EXPORT TO CSV
        // ============================================
        function exportToCSV() {
            if (!inventoryData || inventoryData.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Define columns to export
            const columns = ['IMEI', 'MODEL', 'manufacturer', 'STORAGE', 'GRADE', 'STATUS', 'location', 'cost', 'BATTERY HEALTH', 'created_at'];
            const headers = ['IMEI', 'Model', 'Brand', 'Storage', 'Grade', 'Status', 'Location', 'Cost', 'Battery Health', 'Date Added'];
            
            let csv = headers.join(',') + '\n';
            
            inventoryData.forEach(item => {
                const row = columns.map(col => {
                    let val = item[col] || '';
                    // Handle cost formatting
                    if (col === 'cost' && typeof val === 'number') {
                        val = val.toFixed(2);
                    }
                    // Escape commas and quotes
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = `"${val}"`;
                    }
                    return val;
                });
                csv += row.join(',') + '\n';
            });
            
            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            // Generate filename with date and filter info
            const date = new Date().toISOString().split('T')[0];
            const locationFilter = document.getElementById('locationFilter')?.value || 'all';
            const filterSuffix = locationFilter !== 'all' ? `_${locationFilter.replace(/[^a-zA-Z0-9]/g, '')}` : '';
            link.download = `Universal_Inventory_${date}${filterSuffix}.csv`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ============================================
        // AUTO-REFRESH (every 5 minutes)
        // ============================================
        let refreshInterval = null;
        let countdownInterval = null;
        let secondsUntilRefresh = 300; // 5 minutes
        
        function startAutoRefresh() {
            // Clear any existing intervals
            if (refreshInterval) clearInterval(refreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            secondsUntilRefresh = 300;
            
            // Update countdown every second
            countdownInterval = setInterval(() => {
                secondsUntilRefresh--;
                if (secondsUntilRefresh < 0) secondsUntilRefresh = 300;
                
                const mins = Math.floor(secondsUntilRefresh / 60);
                const secs = secondsUntilRefresh % 60;
                const countdownEl = document.getElementById('refreshCountdown');
                if (countdownEl) {
                    countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            // Refresh data every 5 minutes
            refreshInterval = setInterval(() => {
                secondsUntilRefresh = 300;
                loadData();
                
                // Flash the sync indicator
                const syncDot = document.getElementById('syncDot');
                const syncText = document.getElementById('syncText');
                if (syncDot && syncText) {
                    syncDot.classList.remove('online');
                    syncDot.classList.add('syncing');
                    syncText.textContent = 'Refreshing...';
                    
                    setTimeout(() => {
                        syncDot.classList.remove('syncing');
                        syncDot.classList.add('online');
                        syncText.textContent = 'Live';
                    }, 2000);
                }
            }, 300000); // 5 minutes in ms
        }

        // ============================================
        // ENHANCED LAST UPDATED DISPLAY
        // ============================================
        function updateLastUpdatedEnhanced() {
            const now = new Date();
            const estTime = now.toLocaleString('en-US', { 
                timeZone: 'America/New_York',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            document.getElementById('lastUpdated').textContent = `Last updated: ${estTime} EST`;
        }

        // Override the original updateLastUpdated
        function updateLastUpdated() {
            updateLastUpdatedEnhanced();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateGreeting();
            loadData();
            startAutoRefresh();
            
            // Update greeting every minute in case day changes
            setInterval(updateGreeting, 60000);
        });
    </script>
</body>
</html>
